<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circles of Commitment - The Hub | Granger Community Church</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 79.2 79.2'%3E%3Cpath d='M79.2,79.2h-19.8v-19.8h-19.8v-19.8h39.6v39.6h0ZM59.4,19.8H19.8v59.4H0V0h59.4v19.8h0Z' fill='%23AAD43C' fill-rule='evenodd'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'granger-green': '#AAD43C',
                        'granger-green-alt': '#90c23e',
                        'granger-black': '#252525',
                        'granger-dark': '#1a1a1a',
                    },
                    fontFamily: {
                        'poppins': ['Poppins', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
        }

        /* Concentric circles visualization */
        .circles-container {
            position: relative;
            width: 280px;
            height: 280px;
        }

        .circle {
            position: absolute;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .circle:hover {
            transform: scale(1.02);
            box-shadow: 0 0 30px rgba(170, 212, 60, 0.3);
        }

        .circle-community {
            width: 280px;
            height: 280px;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 3px dashed #AAD43C;
            top: 0;
            left: 0;
        }

        .circle-crowd {
            width: 224px;
            height: 224px;
            background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
            border: 3px solid #AAD43C;
            top: 28px;
            left: 28px;
        }

        .circle-congregation {
            width: 168px;
            height: 168px;
            background: linear-gradient(135deg, #a5d6a7 0%, #81c784 100%);
            border: 3px solid #90c23e;
            top: 56px;
            left: 56px;
        }

        .circle-committed {
            width: 112px;
            height: 112px;
            background: linear-gradient(135deg, #81c784 0%, #66bb6a 100%);
            border: 3px solid #90c23e;
            top: 84px;
            left: 84px;
        }

        .circle-core {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #AAD43C 0%, #90c23e 100%);
            border: 3px solid #7da32d;
            top: 112px;
            left: 112px;
        }

        .circle-label {
            position: absolute;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 10px;
            color: #252525;
            white-space: nowrap;
        }

        .stat-card {
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.15);
        }

        .trend-up {
            color: #AAD43C;
        }

        .trend-down {
            color: #ef4444;
        }

        /* Circle Axis Icons */
        .circle-axis-labels {
            display: flex;
            justify-content: space-around;
            padding-left: 42px;
            padding-right: 8px;
            margin-top: -4px;
        }
        .circle-axis-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .circle-axis-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .circle-axis-icon.community {
            background-color: rgba(200, 230, 201, 0.3);
            border: 2px dashed #a5d6a7;
        }
        .circle-axis-icon.crowd {
            background-color: #c8e6c9;
            border: 2px solid #a5d6a7;
        }
        .circle-axis-icon.congregation {
            background-color: #a5d6a7;
            border: 2px solid #81c784;
        }
        .circle-axis-icon.committed {
            background-color: #81c784;
            border: 2px solid #66bb6a;
        }
        .circle-axis-icon.core {
            background-color: #AAD43C;
            border: 2px solid #7da32d;
        }
        .circle-axis-text {
            font-size: 9px;
            font-weight: 600;
            color: #374151;
        }

        .sidebar-link {
            transition: all 0.2s ease;
        }

        .sidebar-link:hover {
            background-color: rgba(170, 212, 60, 0.1);
        }

        .sidebar-link.active {
            background-color: rgba(170, 212, 60, 0.2);
            border-left: 3px solid #AAD43C;
        }

        /* Tab Navigation */
        .tab-btn {
            padding: 12px 24px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.05em;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
            background: none;
            cursor: pointer;
        }
        .tab-btn:hover { color: #252525; }
        .tab-btn.active {
            color: #252525;
            border-bottom-color: #AAD43C;
        }

        .tab-content {
            display: block;
        }
        .tab-content.hidden {
            display: none;
        }

        /* Clickable table rows */
        .clickable-row {
            cursor: pointer;
        }
        .clickable-row:hover {
            background-color: #f3f4f6;
        }

        /* Collapsible sections for Circle Configuration */
        .config-group-header {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .config-group-header:hover {
            background-color: #f9fafb;
        }

        /* Multiselect Dropdown */
        .multiselect {
            position: relative;
            min-width: 160px;
        }

        .multiselect-btn {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            width: 100%;
            background: white;
            border: 1px solid #d1d5db;
            padding: 8px 12px;
            font-size: 14px;
            font-weight: 600;
            color: #252525;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .multiselect-btn:hover {
            border-color: #AAD43C;
        }

        .multiselect-btn:focus {
            outline: none;
            border-color: #AAD43C;
            box-shadow: 0 0 0 2px rgba(170, 212, 60, 0.2);
        }

        .multiselect-btn .chevron {
            transition: transform 0.2s ease;
        }

        .multiselect.open .multiselect-btn .chevron {
            transform: rotate(180deg);
        }

        .multiselect-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            min-width: 200px;
            background: white;
            border: 1px solid #d1d5db;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 50;
            display: none;
            max-height: 280px;
            overflow-y: auto;
        }

        .multiselect.open .multiselect-dropdown {
            display: block;
        }

        .multiselect-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            cursor: pointer;
            transition: background-color 0.15s ease;
        }

        .multiselect-option:hover {
            background-color: #f3f4f6;
        }

        .multiselect-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #AAD43C;
            cursor: pointer;
        }

        .multiselect-option label {
            flex: 1;
            cursor: pointer;
            font-size: 13px;
            color: #374151;
        }

        .multiselect-option.selected {
            background-color: rgba(170, 212, 60, 0.1);
        }

        .multiselect-select-all {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            cursor: pointer;
            transition: background-color 0.15s ease;
            border-bottom: 1px solid #e5e7eb;
            background-color: #f9fafb;
        }

        .multiselect-select-all:hover {
            background-color: #f3f4f6;
        }

        .multiselect-select-all input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #AAD43C;
            cursor: pointer;
        }

        .multiselect-select-all label {
            flex: 1;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .multiselect-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #AAD43C;
            color: #252525;
            font-size: 11px;
            font-weight: 700;
            min-width: 20px;
            height: 20px;
            border-radius: 10px;
            padding: 0 6px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #9ca3af;
        }

        /* Chart Type Switcher */
        .chart-type-btn {
            padding: 6px 8px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .chart-type-btn:first-child {
            border-radius: 4px 0 0 4px;
        }
        .chart-type-btn:last-child {
            border-radius: 0 4px 4px 0;
        }
        .chart-type-btn:not(:last-child) {
            border-right: none;
        }
        .chart-type-btn:hover {
            background: #e5e7eb;
            color: #374151;
        }
        .chart-type-btn.active {
            background: #252525;
            border-color: #252525;
            color: white;
        }

        </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Top Navigation -->
    <nav class="bg-granger-black text-white">
        <div class="max-w-[1600px] mx-auto flex items-center justify-between h-16 px-8">
            <!-- Logo & Title -->
            <div class="flex items-center gap-3">
                <img src="grangerLogo.svg" alt="Granger" class="w-10 h-10 invert">
                <div>
                    <div class="text-sm font-bold uppercase tracking-wider">THE HUB</div>
                    <div class="text-xs text-gray-400 uppercase tracking-wide">Granger Community Church</div>
                </div>
            </div>

            <!-- Search (centered) -->
            <div class="flex-1 max-w-md mx-8">
                <div class="relative">
                    <input type="text" placeholder="Search..." class="w-full bg-neutral-700 text-white px-4 py-2 pl-10 text-sm focus:outline-none focus:ring-2 focus:ring-neutral-500 placeholder-neutral-400">
                    <i data-lucide="search" class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                </div>
            </div>

            <!-- User Menu -->
            <div class="flex items-center gap-4">
                <button class="relative p-2 hover:bg-gray-800 transition">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                    <span class="absolute top-1 right-1 w-2 h-2 bg-granger-green rounded-full"></span>
                </button>
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-granger-green rounded-full flex items-center justify-center">
                        <span class="text-granger-black font-bold text-sm">JD</span>
                    </div>
                    <div class="text-sm">
                        <div class="font-semibold">John Doe</div>
                        <div class="text-xs text-gray-400">Staff</div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div>
        <!-- Main Content -->
        <main class="max-w-[1600px] mx-auto p-8">
            <!-- Page Header -->
            <div class="mb-8">
                <div class="flex items-start justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-granger-black uppercase tracking-tight">Circles of Commitment</h1>
                        <p class="text-gray-500 mt-1">Insight into where people are and where they're heading</p>
                    </div>
                    <button class="bg-granger-black text-white px-4 py-2 font-bold uppercase text-sm tracking-wide hover:bg-neutral-700 transition flex items-center gap-2">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        Sync
                    </button>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="flex gap-1 mb-6 border-b border-gray-200">
                <button class="tab-btn active" data-tab="circle-participants" onclick="switchTab('circle-participants')">Current</button>
                <button class="tab-btn" data-tab="circle-milestones" onclick="switchTab('circle-milestones')">Milestones</button>
                <div id="as-of-tab" class="tab-btn flex items-center gap-2" data-tab="circles-over-time" onclick="switchTab('circles-over-time')">
                    <span>As Of</span>
                    <select id="as-of-select" class="bg-transparent border-none text-xs font-bold uppercase tracking-wide cursor-pointer focus:outline-none" onclick="event.stopPropagation()" onmousedown="if(!document.getElementById('as-of-tab').classList.contains('active')){event.preventDefault();switchTab('circles-over-time');return false;}">
                        <option>January 2026</option>
                        <option>December 2025</option>
                        <option>November 2025</option>
                        <option>October 2025</option>
                        <option>September 2025</option>
                        <option>August 2025</option>
                        <option>July 2025</option>
                        <option>June 2025</option>
                        <option>May 2025</option>
                        <option>April 2025</option>
                        <option>March 2025</option>
                        <option>February 2025</option>
                    </select>
                </div>
            </div>

            <!-- Tab 1: Circles Over Time -->
            <div id="tab-circles-over-time" class="tab-content hidden">

            <!-- Main Content Grid -->
            <div class="grid grid-cols-2 gap-6 items-stretch">
                <!-- Circles Visualization -->
                <div class="bg-white p-6 shadow-sm h-full">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-lg font-bold text-granger-black uppercase tracking-tight">Overview</h2>
                        <button class="text-gray-400 hover:text-granger-black transition">
                            <i data-lucide="maximize-2" class="w-4 h-4"></i>
                        </button>
                    </div>

                    <div class="flex items-center gap-8">
                        <!-- Circles -->
                        <div class="circles-container flex-shrink-0">
                            <div class="circle circle-community" data-level="community">
                                <span class="circle-label" style="top: 2px; left: 50%; transform: translateX(-50%);"><i data-lucide="globe" class="w-5 h-5" style="color: #4a7c4e;"></i></span>
                            </div>
                            <div class="circle circle-crowd" data-level="crowd">
                                <span class="circle-label" style="top: 2px; left: 50%; transform: translateX(-50%);"><i data-lucide="users" class="w-5 h-5" style="color: #3d6b40;"></i></span>
                            </div>
                            <div class="circle circle-congregation" data-level="congregation">
                                <span class="circle-label" style="top: 2px; left: 50%; transform: translateX(-50%);"><i data-lucide="church" class="w-5 h-5" style="color: #2d5a30;"></i></span>
                            </div>
                            <div class="circle circle-committed" data-level="committed">
                                <span class="circle-label" style="top: 2px; left: 50%; transform: translateX(-50%);"><i data-lucide="heart-handshake" class="w-5 h-5" style="color: #fff;"></i></span>
                            </div>
                            <div class="circle circle-core" data-level="core">
                                <span class="circle-label" style="top: 50%; left: 50%; transform: translate(-50%, -50%);"><i data-lucide="star" class="w-4 h-4" style="color: #fff;"></i></span>
                            </div>
                        </div>

                        <!-- Legend with counts -->
                        <div class="flex-1">
                            <div class="space-y-1">
                            <div class="flex items-center gap-3 p-2 -mx-2 rounded cursor-pointer hover:bg-gray-50 transition" >
                                <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center" style="background-color: rgba(200, 230, 201, 0.3); border: 2px dashed #a5d6a7;">
                                    <i data-lucide="globe" class="w-4 h-4" style="color: #66bb6a;"></i>
                                </div>
                                <span class="font-semibold text-sm text-granger-black flex-1">Community</span>
                                <span class="text-lg font-bold text-granger-black">6,274</span>
                                <span class="text-xs font-semibold trend-up w-12 text-right">+19.4%</span>
                            </div>
                            <div class="flex items-center gap-3 p-2 -mx-2 rounded cursor-pointer hover:bg-gray-50 transition" >
                                <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center" style="background-color: #c8e6c9; border: 2px solid #a5d6a7;">
                                    <i data-lucide="users" class="w-4 h-4" style="color: #4a7c4e;"></i>
                                </div>
                                <span class="font-semibold text-sm text-granger-black flex-1">Crowd</span>
                                <span class="text-lg font-bold text-granger-black">1,344</span>
                                <span class="text-xs font-semibold trend-up w-12 text-right">+6.9%</span>
                            </div>
                            <div class="flex items-center gap-3 p-2 -mx-2 rounded cursor-pointer hover:bg-gray-50 transition" >
                                <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center" style="background-color: #a5d6a7; border: 2px solid #81c784;">
                                    <i data-lucide="church" class="w-4 h-4" style="color: #3d6b40;"></i>
                                </div>
                                <span class="font-semibold text-sm text-granger-black flex-1">Congregation</span>
                                <span class="text-lg font-bold text-granger-black">520</span>
                                <span class="text-xs font-semibold trend-down w-12 text-right">-0.6%</span>
                            </div>
                            <div class="flex items-center gap-3 p-2 -mx-2 rounded cursor-pointer hover:bg-gray-50 transition" >
                                <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center" style="background-color: #81c784; border: 2px solid #66bb6a;">
                                    <i data-lucide="heart-handshake" class="w-4 h-4 text-white"></i>
                                </div>
                                <span class="font-semibold text-sm text-granger-black flex-1">Committed</span>
                                <span class="text-lg font-bold text-granger-black">11,231</span>
                                <span class="text-xs font-semibold trend-up w-12 text-right">+0.2%</span>
                            </div>
                            <div class="flex items-center gap-3 p-2 -mx-2 rounded cursor-pointer hover:bg-gray-50 transition" >
                                <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center" style="background-color: #AAD43C; border: 2px solid #7da32d;">
                                    <i data-lucide="star" class="w-4 h-4 text-white"></i>
                                </div>
                                <span class="font-semibold text-sm text-granger-black flex-1">Core</span>
                                <span class="text-lg font-bold text-granger-black">826</span>
                                <span class="text-xs font-semibold trend-up w-12 text-right">+3.4%</span>
                            </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monthly Trends Chart -->
                <div class="bg-white p-6 shadow-sm flex flex-col h-full">
                    <div class="mb-6">
                        <h2 class="text-lg font-bold text-granger-black uppercase tracking-tight">Movement</h2>
                    </div>
                    <div class="flex-1 min-h-0">
                        <canvas id="trendsChart"></canvas>
                    </div>
                    <!-- Custom Legend with Icons -->
                    <div class="flex justify-center gap-4 mt-4">
                        <div class="flex items-center gap-1.5">
                            <div class="w-5 h-5 rounded-full flex items-center justify-center" style="background-color: rgba(200, 230, 201, 0.3); border: 1.5px dashed #a5d6a7;">
                                <i data-lucide="globe" class="w-2.5 h-2.5" style="color: #66bb6a;"></i>
                            </div>
                            <span class="text-xs font-semibold text-gray-600">Community</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <div class="w-5 h-5 rounded-full flex items-center justify-center" style="background-color: #c8e6c9; border: 1.5px solid #a5d6a7;">
                                <i data-lucide="users" class="w-2.5 h-2.5" style="color: #4a7c4e;"></i>
                            </div>
                            <span class="text-xs font-semibold text-gray-600">Crowd</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <div class="w-5 h-5 rounded-full flex items-center justify-center" style="background-color: #a5d6a7; border: 1.5px solid #81c784;">
                                <i data-lucide="church" class="w-2.5 h-2.5" style="color: #3d6b40;"></i>
                            </div>
                            <span class="text-xs font-semibold text-gray-600">Congregation</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <div class="w-5 h-5 rounded-full flex items-center justify-center" style="background-color: #81c784; border: 1.5px solid #66bb6a;">
                                <i data-lucide="heart-handshake" class="w-2.5 h-2.5 text-white"></i>
                            </div>
                            <span class="text-xs font-semibold text-gray-600">Committed</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <div class="w-5 h-5 rounded-full flex items-center justify-center" style="background-color: #AAD43C; border: 1.5px solid #7da32d;">
                                <i data-lucide="star" class="w-2.5 h-2.5 text-white"></i>
                            </div>
                            <span class="text-xs font-semibold text-gray-600">Core</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom Section -->
            <div class="grid grid-cols-2 gap-6 mt-6">
                <!-- New Joins This Month -->
                <div class="bg-white p-6 shadow-sm">
                    <div class="mb-6">
                        <h2 class="text-lg font-bold text-granger-black uppercase tracking-tight">New Joins</h2>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-100">
                                    <th class="text-left py-3 text-xs font-bold text-gray-400 uppercase tracking-wider">Circle</th>
                                    <th class="text-right py-3 text-xs font-bold text-gray-400 uppercase tracking-wider">Count</th>
                                    <th class="text-right py-3 text-xs font-bold text-gray-400 uppercase tracking-wider">Change</th>
                                    <th class="text-right py-3 text-xs font-bold text-gray-400 uppercase tracking-wider">Trend</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b border-gray-50">
                                    <td class="py-3">
                                        <div class="flex items-center gap-3">
                                            <div class="w-7 h-7 rounded-full flex-shrink-0 flex items-center justify-center" style="background-color: rgba(200, 230, 201, 0.3); border: 2px dashed #a5d6a7;">
                                                <i data-lucide="globe" class="w-3.5 h-3.5" style="color: #66bb6a;"></i>
                                            </div>
                                            <span class="font-semibold text-granger-black">Community</span>
                                        </div>
                                    </td>
                                    <td class="py-3 text-right font-bold text-granger-black">1,020</td>
                                    <td class="py-3 text-right">
                                        <span class="text-sm font-semibold trend-up">+19.4%</span>
                                    </td>
                                    <td class="py-3 text-right">
                                        <i data-lucide="trending-up" class="w-4 h-4 trend-up inline"></i>
                                    </td>
                                </tr>
                                <tr class="border-b border-gray-50">
                                    <td class="py-3">
                                        <div class="flex items-center gap-3">
                                            <div class="w-7 h-7 rounded-full flex-shrink-0 flex items-center justify-center" style="background-color: #c8e6c9; border: 2px solid #a5d6a7;">
                                                <i data-lucide="users" class="w-3.5 h-3.5" style="color: #4a7c4e;"></i>
                                            </div>
                                            <span class="font-semibold text-granger-black">Crowd</span>
                                        </div>
                                    </td>
                                    <td class="py-3 text-right font-bold text-granger-black">87</td>
                                    <td class="py-3 text-right">
                                        <span class="text-sm font-semibold trend-up">+6.9%</span>
                                    </td>
                                    <td class="py-3 text-right">
                                        <i data-lucide="trending-up" class="w-4 h-4 trend-up inline"></i>
                                    </td>
                                </tr>
                                <tr class="border-b border-gray-50">
                                    <td class="py-3">
                                        <div class="flex items-center gap-3">
                                            <div class="w-7 h-7 rounded-full flex-shrink-0 flex items-center justify-center" style="background-color: #a5d6a7; border: 2px solid #81c784;">
                                                <i data-lucide="church" class="w-3.5 h-3.5" style="color: #3d6b40;"></i>
                                            </div>
                                            <span class="font-semibold text-granger-black">Congregation</span>
                                        </div>
                                    </td>
                                    <td class="py-3 text-right font-bold text-granger-black">72</td>
                                    <td class="py-3 text-right">
                                        <span class="text-sm font-semibold trend-up">+15.9%</span>
                                    </td>
                                    <td class="py-3 text-right">
                                        <i data-lucide="trending-up" class="w-4 h-4 trend-up inline"></i>
                                    </td>
                                </tr>
                                <tr class="border-b border-gray-50">
                                    <td class="py-3">
                                        <div class="flex items-center gap-3">
                                            <div class="w-7 h-7 rounded-full flex-shrink-0 flex items-center justify-center" style="background-color: #81c784; border: 2px solid #66bb6a;">
                                                <i data-lucide="heart-handshake" class="w-3.5 h-3.5 text-white"></i>
                                            </div>
                                            <span class="font-semibold text-granger-black">Committed</span>
                                        </div>
                                    </td>
                                    <td class="py-3 text-right font-bold text-granger-black">18</td>
                                    <td class="py-3 text-right">
                                        <span class="text-sm font-semibold trend-up">+0.2%</span>
                                    </td>
                                    <td class="py-3 text-right">
                                        <i data-lucide="trending-up" class="w-4 h-4 trend-up inline"></i>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="py-3">
                                        <div class="flex items-center gap-3">
                                            <div class="w-7 h-7 rounded-full flex-shrink-0 flex items-center justify-center" style="background-color: #AAD43C; border: 2px solid #7da32d;">
                                                <i data-lucide="star" class="w-3.5 h-3.5 text-white"></i>
                                            </div>
                                            <span class="font-semibold text-granger-black">Core</span>
                                        </div>
                                    </td>
                                    <td class="py-3 text-right font-bold text-granger-black">27</td>
                                    <td class="py-3 text-right">
                                        <span class="text-sm font-semibold trend-up">+3.4%</span>
                                    </td>
                                    <td class="py-3 text-right">
                                        <i data-lucide="trending-up" class="w-4 h-4 trend-up inline"></i>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    </div>

                <!-- In Chart -->
                <div class="bg-white p-6 shadow-sm flex flex-col">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-lg font-bold text-granger-black uppercase tracking-tight">In</h2>
                    </div>
                    <div class="flex-1 min-h-0">
                        <canvas id="inChart"></canvas>
                    </div>
                </div>
            </div>
            </div><!-- End Tab 1 -->

            <!-- Tab 2: Circle Participants -->
            <div id="tab-circle-participants" class="tab-content">
                <!-- Filter Bar -->
                <div class="bg-white p-4 shadow-sm mb-6">
                    <div class="flex items-center justify-between gap-4">
                        <div class="flex items-center gap-2 flex-wrap flex-1">
                            <!-- Campus Filter -->
                            <div class="filter-group">
                                <span class="filter-label">Campus</span>
                                <div class="multiselect" data-filter="campus">
                                    <button type="button" class="multiselect-btn" onclick="toggleMultiselect(this)">
                                        <span class="multiselect-label">All Campuses</span>
                                        <i data-lucide="chevron-down" class="w-4 h-4 chevron"></i>
                                    </button>
                                    <div class="multiselect-dropdown">
                                        <div class="multiselect-select-all">
                                            <input type="checkbox" id="campus-all">
                                            <label for="campus-all">Select All</label>
                                        </div>
                                        <div class="multiselect-option" data-value="1">
                                            <input type="checkbox" id="campus-1">
                                            <label for="campus-1">Granger Campus</label>
                                        </div>
                                        <div class="multiselect-option" data-value="4">
                                            <input type="checkbox" id="campus-4">
                                            <label for="campus-4">Elkhart Campus</label>
                                        </div>
                                        <div class="multiselect-option" data-value="6">
                                            <input type="checkbox" id="campus-6">
                                            <label for="campus-6">All Church</label>
                                        </div>
                                        <div class="multiselect-option" data-value="9">
                                            <input type="checkbox" id="campus-9">
                                            <label for="campus-9">Online</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Participant Type Filter -->
                            <div class="filter-group">
                                <span class="filter-label">Participant Type</span>
                                <div class="multiselect" data-filter="participant-type">
                                    <button type="button" class="multiselect-btn" onclick="toggleMultiselect(this)">
                                        <span class="multiselect-label">All Types</span>
                                        <i data-lucide="chevron-down" class="w-4 h-4 chevron"></i>
                                    </button>
                                    <div class="multiselect-dropdown">
                                        <div class="multiselect-select-all">
                                            <input type="checkbox" id="ptype-all">
                                            <label for="ptype-all">Select All</label>
                                        </div>
                                        <div class="multiselect-option" data-value="35">
                                            <input type="checkbox" id="ptype-35">
                                            <label for="ptype-35">Church Family</label>
                                        </div>
                                        <div class="multiselect-option" data-value="29">
                                            <input type="checkbox" id="ptype-29">
                                            <label for="ptype-29">Attendee</label>
                                        </div>
                                        <div class="multiselect-option" data-value="28">
                                            <input type="checkbox" id="ptype-28">
                                            <label for="ptype-28">New</label>
                                        </div>
                                        <div class="multiselect-option" data-value="24">
                                            <input type="checkbox" id="ptype-24">
                                            <label for="ptype-24">MC3 Neighbor</label>
                                        </div>
                                        <div class="multiselect-option" data-value="34">
                                            <input type="checkbox" id="ptype-34">
                                            <label for="ptype-34">Non-Attending/Other</label>
                                        </div>
                                        <div class="multiselect-option" data-value="33">
                                            <input type="checkbox" id="ptype-33">
                                            <label for="ptype-33">Dropped</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Engagement Filter -->
                            <div class="filter-group">
                                <span class="filter-label">Engagement</span>
                                <div class="multiselect" data-filter="engagement">
                                    <button type="button" class="multiselect-btn" onclick="toggleMultiselect(this)">
                                        <span class="multiselect-label">All Engagement</span>
                                        <i data-lucide="chevron-down" class="w-4 h-4 chevron"></i>
                                    </button>
                                    <div class="multiselect-dropdown">
                                        <div class="multiselect-select-all">
                                            <input type="checkbox" id="eng-all">
                                            <label for="eng-all">Select All</label>
                                        </div>
                                        <div class="multiselect-option" data-value="2">
                                            <input type="checkbox" id="eng-2">
                                            <label for="eng-2">Fully Engaged</label>
                                        </div>
                                        <div class="multiselect-option" data-value="1">
                                            <input type="checkbox" id="eng-1">
                                            <label for="eng-1">Partially Engaged</label>
                                        </div>
                                        <div class="multiselect-option" data-value="3">
                                            <input type="checkbox" id="eng-3">
                                            <label for="eng-3">Lapsing</label>
                                        </div>
                                        <div class="multiselect-option" data-value="5">
                                            <input type="checkbox" id="eng-5">
                                            <label for="eng-5">Observing</label>
                                        </div>
                                        <div class="multiselect-option" data-value="4">
                                            <input type="checkbox" id="eng-4">
                                            <label for="eng-4">Lapsed</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Household Position Filter -->
                            <div class="filter-group">
                                <span class="filter-label">Household Position</span>
                                <div class="multiselect" data-filter="household-position">
                                    <button type="button" class="multiselect-btn" onclick="toggleMultiselect(this)">
                                        <span class="multiselect-label">All Positions</span>
                                        <i data-lucide="chevron-down" class="w-4 h-4 chevron"></i>
                                    </button>
                                    <div class="multiselect-dropdown">
                                        <div class="multiselect-select-all">
                                            <input type="checkbox" id="hpos-all">
                                            <label for="hpos-all">Select All</label>
                                        </div>
                                        <div class="multiselect-option" data-value="1">
                                            <input type="checkbox" id="hpos-1">
                                            <label for="hpos-1">Head of Household</label>
                                        </div>
                                        <div class="multiselect-option" data-value="2">
                                            <input type="checkbox" id="hpos-2">
                                            <label for="hpos-2">Minor Child</label>
                                        </div>
                                        <div class="multiselect-option" data-value="3">
                                            <input type="checkbox" id="hpos-3">
                                            <label for="hpos-3">Other Adult</label>
                                        </div>
                                        <div class="multiselect-option" data-value="4">
                                            <input type="checkbox" id="hpos-4">
                                            <label for="hpos-4">Adult Child</label>
                                        </div>
                                        <div class="multiselect-option" data-value="5">
                                            <input type="checkbox" id="hpos-5">
                                            <label for="hpos-5">Guest Child</label>
                                        </div>
                                        <div class="multiselect-option" data-value="6">
                                            <input type="checkbox" id="hpos-6">
                                            <label for="hpos-6">Company</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Marital Status Filter -->
                            <div class="filter-group">
                                <span class="filter-label">Marital Status</span>
                                <div class="multiselect" data-filter="marital-status">
                                    <button type="button" class="multiselect-btn" onclick="toggleMultiselect(this)">
                                        <span class="multiselect-label">All Statuses</span>
                                        <i data-lucide="chevron-down" class="w-4 h-4 chevron"></i>
                                    </button>
                                    <div class="multiselect-dropdown">
                                        <div class="multiselect-select-all">
                                            <input type="checkbox" id="marital-all">
                                            <label for="marital-all">Select All</label>
                                        </div>
                                        <div class="multiselect-option" data-value="2">
                                            <input type="checkbox" id="marital-2">
                                            <label for="marital-2">Married</label>
                                        </div>
                                        <div class="multiselect-option" data-value="1">
                                            <input type="checkbox" id="marital-1">
                                            <label for="marital-1">Single</label>
                                        </div>
                                        <div class="multiselect-option" data-value="3">
                                            <input type="checkbox" id="marital-3">
                                            <label for="marital-3">Divorced</label>
                                        </div>
                                        <div class="multiselect-option" data-value="4">
                                            <input type="checkbox" id="marital-4">
                                            <label for="marital-4">Widowed</label>
                                        </div>
                                        <div class="multiselect-option" data-value="6">
                                            <input type="checkbox" id="marital-6">
                                            <label for="marital-6">Separated</label>
                                        </div>
                                        <div class="multiselect-option" data-value="5">
                                            <input type="checkbox" id="marital-5">
                                            <label for="marital-5">Partnered</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Gender Filter -->
                            <div class="filter-group">
                                <span class="filter-label">Gender</span>
                                <div class="multiselect" data-filter="gender">
                                    <button type="button" class="multiselect-btn" onclick="toggleMultiselect(this)">
                                        <span class="multiselect-label">All Genders</span>
                                        <i data-lucide="chevron-down" class="w-4 h-4 chevron"></i>
                                    </button>
                                    <div class="multiselect-dropdown">
                                        <div class="multiselect-select-all">
                                            <input type="checkbox" id="gender-all">
                                            <label for="gender-all">Select All</label>
                                        </div>
                                        <div class="multiselect-option" data-value="1">
                                            <input type="checkbox" id="gender-1">
                                            <label for="gender-1">Male</label>
                                        </div>
                                        <div class="multiselect-option" data-value="2">
                                            <input type="checkbox" id="gender-2">
                                            <label for="gender-2">Female</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button onclick="resetAllFilters()" class="px-4 py-2 text-sm font-semibold text-gray-600 hover:text-granger-black hover:bg-gray-100 transition whitespace-nowrap">
                            Reset Filters
                        </button>
                    </div>
                </div>

                <!-- Charts Row 1 -->
                <div class="grid grid-cols-2 gap-6 mb-6">
                    <!-- Distribution -->
                    <div class="bg-white p-6 shadow-sm flex flex-col">
                        <h3 class="text-lg font-bold text-granger-black uppercase tracking-tight mb-4">Distribution</h3>
                        <div class="h-48 flex-1">
                            <canvas id="participantsCircleChart"></canvas>
                        </div>
                        <!-- Custom Legend with Stats -->
                        <div id="distribution-legend" class="grid grid-cols-5 gap-3 mt-auto pt-4">
                            <div class="p-4 rounded flex flex-col h-28 relative overflow-hidden" style="background-color: #c8e6c9;">
                                <i data-lucide="globe" class="absolute -bottom-2 -right-2 w-16 h-16 opacity-20" style="color: #2e7d32;"></i>
                                <div class="text-xs font-bold uppercase tracking-wide text-granger-black opacity-70">Community</div>
                                <div class="mt-auto">
                                    <div class="text-2xl font-bold text-granger-black">6,274</div>
                                    <div class="text-sm text-granger-black opacity-60">31.1%</div>
                                </div>
                            </div>
                            <div class="p-4 rounded flex flex-col h-28 relative overflow-hidden" style="background-color: #a5d6a7;">
                                <i data-lucide="users" class="absolute -bottom-2 -right-2 w-16 h-16 opacity-20" style="color: #2e7d32;"></i>
                                <div class="text-xs font-bold uppercase tracking-wide text-granger-black opacity-70">Crowd</div>
                                <div class="mt-auto">
                                    <div class="text-2xl font-bold text-granger-black">1,344</div>
                                    <div class="text-sm text-granger-black opacity-60">6.7%</div>
                                </div>
                            </div>
                            <div class="p-4 rounded flex flex-col h-28 relative overflow-hidden" style="background-color: #81c784;">
                                <i data-lucide="church" class="absolute -bottom-2 -right-2 w-16 h-16 opacity-20" style="color: #1b5e20;"></i>
                                <div class="text-xs font-bold uppercase tracking-wide text-white opacity-90">Congregation</div>
                                <div class="mt-auto">
                                    <div class="text-2xl font-bold text-white">520</div>
                                    <div class="text-sm text-white opacity-75">2.6%</div>
                                </div>
                            </div>
                            <div class="p-4 rounded flex flex-col h-28 relative overflow-hidden" style="background-color: #66bb6a;">
                                <i data-lucide="heart-handshake" class="absolute -bottom-2 -right-2 w-16 h-16 opacity-20" style="color: #1b5e20;"></i>
                                <div class="text-xs font-bold uppercase tracking-wide text-white opacity-90">Committed</div>
                                <div class="mt-auto">
                                    <div class="text-2xl font-bold text-white">11,231</div>
                                    <div class="text-sm text-white opacity-75">55.6%</div>
                                </div>
                            </div>
                            <div class="p-4 rounded flex flex-col h-28 relative overflow-hidden" style="background-color: #AAD43C;">
                                <i data-lucide="star" class="absolute -bottom-2 -right-2 w-16 h-16 opacity-20" style="color: #5a7a1f;"></i>
                                <div class="text-xs font-bold uppercase tracking-wide text-white opacity-90">Core</div>
                                <div class="mt-auto">
                                    <div class="text-2xl font-bold text-white">826</div>
                                    <div class="text-sm text-white opacity-75">4.1%</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Engagement -->
                    <div class="bg-white p-6 shadow-sm flex flex-col">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-granger-black uppercase tracking-tight">Engagement</h3>
                            <div class="flex gap-1">
                                <button class="chart-type-btn active" data-chart-group="engagement" data-chart="stacked" onclick="switchEngagementChart('stacked')" title="Stacked Bar">
                                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="6" height="18"/><rect x="9" y="8" width="6" height="13"/><rect x="15" y="12" width="6" height="9"/></svg>
                                </button>
                                <button class="chart-type-btn" data-chart-group="engagement" data-chart="percent" onclick="switchEngagementChart('percent')" title="100% Stacked">
                                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="6" height="18"/><rect x="9" y="3" width="6" height="18"/><rect x="15" y="3" width="6" height="18"/></svg>
                                </button>
                                <button class="chart-type-btn" data-chart-group="engagement" data-chart="grouped" onclick="switchEngagementChart('grouped')" title="Grouped Bar">
                                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="6" width="3" height="15"/><rect x="6" y="10" width="3" height="11"/><rect x="10" y="8" width="3" height="13"/><rect x="14" y="4" width="3" height="17"/><rect x="18" y="12" width="3" height="9"/></svg>
                                </button>
                                <button class="chart-type-btn" data-chart-group="engagement" data-chart="matrix" onclick="switchEngagementChart('matrix')" title="Matrix Heatmap">
                                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="5" height="5"/><rect x="9" y="3" width="5" height="5"/><rect x="15" y="3" width="5" height="5"/><rect x="3" y="9" width="5" height="5"/><rect x="9" y="9" width="5" height="5"/><rect x="15" y="9" width="5" height="5"/><rect x="3" y="15" width="5" height="5"/><rect x="9" y="15" width="5" height="5"/><rect x="15" y="15" width="5" height="5"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="h-56 flex-1">
                            <canvas id="engagementByCircleChart"></canvas>
                        </div>
                        <!-- Custom Legend with Stats -->
                        <div id="engagement-legend" class="grid grid-cols-5 gap-3 mt-auto pt-4">
                            <div class="p-4 rounded flex flex-col h-28" style="background-color: #AAD43C;">
                                <div class="text-xs font-bold uppercase tracking-wide text-white opacity-90">Fully Engaged</div>
                                <div class="mt-auto">
                                    <div class="text-2xl font-bold text-white">5,324</div>
                                    <div class="text-sm text-white opacity-75">26.4%</div>
                                </div>
                            </div>
                            <div class="p-4 rounded flex flex-col h-28" style="background-color: #eab308;">
                                <div class="text-xs font-bold uppercase tracking-wide text-white opacity-90">Partially Engaged</div>
                                <div class="mt-auto">
                                    <div class="text-2xl font-bold text-white">9,007</div>
                                    <div class="text-sm text-white opacity-75">44.6%</div>
                                </div>
                            </div>
                            <div class="p-4 rounded flex flex-col h-28" style="background-color: #f97316;">
                                <div class="text-xs font-bold uppercase tracking-wide text-white opacity-90">Lapsing</div>
                                <div class="mt-auto">
                                    <div class="text-2xl font-bold text-white">3,615</div>
                                    <div class="text-sm text-white opacity-75">17.9%</div>
                                </div>
                            </div>
                            <div class="p-4 rounded flex flex-col h-28" style="background-color: #3b82f6;">
                                <div class="text-xs font-bold uppercase tracking-wide text-white opacity-90">Observing</div>
                                <div class="mt-auto">
                                    <div class="text-2xl font-bold text-white">1,413</div>
                                    <div class="text-sm text-white opacity-75">7.0%</div>
                                </div>
                            </div>
                            <div class="p-4 rounded flex flex-col h-28" style="background-color: #ef4444;">
                                <div class="text-xs font-bold uppercase tracking-wide text-white opacity-90">Lapsed</div>
                                <div class="mt-auto">
                                    <div class="text-2xl font-bold text-white">836</div>
                                    <div class="text-sm text-white opacity-75">4.1%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row 3 -->
                <div class="grid grid-cols-2 gap-6">
                    <!-- Participant Type -->
                    <div class="bg-white p-6 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-granger-black uppercase tracking-tight">Participants</h3>
                            <div class="flex gap-1">
                                <button class="chart-type-btn active" data-chart-group="participant" data-chart="stacked" onclick="switchParticipantChart('stacked')" title="Stacked Bar">
                                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="6" height="18"/><rect x="9" y="8" width="6" height="13"/><rect x="15" y="12" width="6" height="9"/></svg>
                                </button>
                                <button class="chart-type-btn" data-chart-group="participant" data-chart="percent" onclick="switchParticipantChart('percent')" title="100% Stacked">
                                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="6" height="18"/><rect x="9" y="3" width="6" height="18"/><rect x="15" y="3" width="6" height="18"/></svg>
                                </button>
                                <button class="chart-type-btn" data-chart-group="participant" data-chart="grouped" onclick="switchParticipantChart('grouped')" title="Grouped Bar">
                                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="6" width="3" height="15"/><rect x="6" y="10" width="3" height="11"/><rect x="10" y="8" width="3" height="13"/><rect x="14" y="4" width="3" height="17"/><rect x="18" y="12" width="3" height="9"/></svg>
                                </button>
                                <button class="chart-type-btn" data-chart-group="participant" data-chart="matrix" onclick="switchParticipantChart('matrix')" title="Matrix Heatmap">
                                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="5" height="5"/><rect x="9" y="3" width="5" height="5"/><rect x="15" y="3" width="5" height="5"/><rect x="3" y="9" width="5" height="5"/><rect x="9" y="9" width="5" height="5"/><rect x="15" y="9" width="5" height="5"/><rect x="3" y="15" width="5" height="5"/><rect x="9" y="15" width="5" height="5"/><rect x="15" y="15" width="5" height="5"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="h-52">
                            <canvas id="participantTypeChart"></canvas>
                        </div>
                        <!-- Custom Legend with Stats -->
                        <div id="participant-legend" class="grid grid-cols-6 gap-2 mt-4">
                            <div class="p-3 rounded flex flex-col h-24" style="background-color: #3b82f6;">
                                <div class="text-xs font-bold uppercase tracking-wide text-white opacity-90">Church Family</div>
                                <div class="mt-auto">
                                    <div class="text-xl font-bold text-white">12,542</div>
                                    <div class="text-xs text-white opacity-75">62.1%</div>
                                </div>
                            </div>
                            <div class="p-3 rounded flex flex-col h-24" style="background-color: #6366f1;">
                                <div class="text-xs font-bold uppercase tracking-wide text-white opacity-90">Attendee</div>
                                <div class="mt-auto">
                                    <div class="text-xl font-bold text-white">4,231</div>
                                    <div class="text-xs text-white opacity-75">21.0%</div>
                                </div>
                            </div>
                            <div class="p-3 rounded flex flex-col h-24" style="background-color: #8b5cf6;">
                                <div class="text-xs font-bold uppercase tracking-wide text-white opacity-90">New</div>
                                <div class="mt-auto">
                                    <div class="text-xl font-bold text-white">1,823</div>
                                    <div class="text-xs text-white opacity-75">9.0%</div>
                                </div>
                            </div>
                            <div class="p-3 rounded flex flex-col h-24" style="background-color: #a855f7;">
                                <div class="text-xs font-bold uppercase tracking-wide text-white opacity-90">MC3 Neighbor</div>
                                <div class="mt-auto">
                                    <div class="text-xl font-bold text-white">876</div>
                                    <div class="text-xs text-white opacity-75">4.3%</div>
                                </div>
                            </div>
                            <div class="p-3 rounded flex flex-col h-24" style="background-color: #d946ef;">
                                <div class="text-xs font-bold uppercase tracking-wide text-white opacity-90">Non-Attending</div>
                                <div class="mt-auto">
                                    <div class="text-xl font-bold text-white">512</div>
                                    <div class="text-xs text-white opacity-75">2.5%</div>
                                </div>
                            </div>
                            <div class="p-3 rounded flex flex-col h-24" style="background-color: #ec4899;">
                                <div class="text-xs font-bold uppercase tracking-wide text-white opacity-90">Dropped</div>
                                <div class="mt-auto">
                                    <div class="text-xl font-bold text-white">211</div>
                                    <div class="text-xs text-white opacity-75">1.0%</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Household Position -->
                    <div class="bg-white p-6 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-granger-black uppercase tracking-tight">Demographics</h3>
                            <div class="flex gap-1">
                                <button class="chart-type-btn active" data-chart-group="demographics" data-chart="stacked" onclick="switchDemographicsChart('stacked')" title="Stacked Bar">
                                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="6" height="18"/><rect x="9" y="8" width="6" height="13"/><rect x="15" y="12" width="6" height="9"/></svg>
                                </button>
                                <button class="chart-type-btn" data-chart-group="demographics" data-chart="percent" onclick="switchDemographicsChart('percent')" title="100% Stacked">
                                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="6" height="18"/><rect x="9" y="3" width="6" height="18"/><rect x="15" y="3" width="6" height="18"/></svg>
                                </button>
                                <button class="chart-type-btn" data-chart-group="demographics" data-chart="grouped" onclick="switchDemographicsChart('grouped')" title="Grouped Bar">
                                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="6" width="3" height="15"/><rect x="6" y="10" width="3" height="11"/><rect x="10" y="8" width="3" height="13"/><rect x="14" y="4" width="3" height="17"/><rect x="18" y="12" width="3" height="9"/></svg>
                                </button>
                                <button class="chart-type-btn" data-chart-group="demographics" data-chart="matrix" onclick="switchDemographicsChart('matrix')" title="Matrix Heatmap">
                                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="5" height="5"/><rect x="9" y="3" width="5" height="5"/><rect x="15" y="3" width="5" height="5"/><rect x="3" y="9" width="5" height="5"/><rect x="9" y="9" width="5" height="5"/><rect x="15" y="9" width="5" height="5"/><rect x="3" y="15" width="5" height="5"/><rect x="9" y="15" width="5" height="5"/><rect x="15" y="15" width="5" height="5"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="h-52">
                            <canvas id="householdPositionChart"></canvas>
                        </div>
                        <!-- Custom Legend with Stats -->
                        <div id="demographics-legend" class="grid grid-cols-6 gap-2 mt-4">
                            <div class="p-3 rounded flex flex-col h-24" style="background-color: #f97316;">
                                <div class="text-xs font-bold uppercase tracking-wide text-white opacity-90">Head of Household</div>
                                <div class="mt-auto">
                                    <div class="text-xl font-bold text-white">8,934</div>
                                    <div class="text-xs text-white opacity-75">44.2%</div>
                                </div>
                            </div>
                            <div class="p-3 rounded flex flex-col h-24" style="background-color: #fb923c;">
                                <div class="text-xs font-bold uppercase tracking-wide text-white opacity-90">Minor Child</div>
                                <div class="mt-auto">
                                    <div class="text-xl font-bold text-white">5,621</div>
                                    <div class="text-xs text-white opacity-75">27.8%</div>
                                </div>
                            </div>
                            <div class="p-3 rounded flex flex-col h-24" style="background-color: #fbbf24;">
                                <div class="text-xs font-bold uppercase tracking-wide text-granger-black opacity-70">Other Adult</div>
                                <div class="mt-auto">
                                    <div class="text-xl font-bold text-granger-black">3,212</div>
                                    <div class="text-xs text-granger-black opacity-60">15.9%</div>
                                </div>
                            </div>
                            <div class="p-3 rounded flex flex-col h-24" style="background-color: #facc15;">
                                <div class="text-xs font-bold uppercase tracking-wide text-granger-black opacity-70">Adult Child</div>
                                <div class="mt-auto">
                                    <div class="text-xl font-bold text-granger-black">1,876</div>
                                    <div class="text-xs text-granger-black opacity-60">9.3%</div>
                                </div>
                            </div>
                            <div class="p-3 rounded flex flex-col h-24" style="background-color: #a3e635;">
                                <div class="text-xs font-bold uppercase tracking-wide text-granger-black opacity-70">Guest Child</div>
                                <div class="mt-auto">
                                    <div class="text-xl font-bold text-granger-black">423</div>
                                    <div class="text-xs text-granger-black opacity-60">2.1%</div>
                                </div>
                            </div>
                            <div class="p-3 rounded flex flex-col h-24" style="background-color: #4ade80;">
                                <div class="text-xs font-bold uppercase tracking-wide text-granger-black opacity-70">Company</div>
                                <div class="mt-auto">
                                    <div class="text-xl font-bold text-granger-black">129</div>
                                    <div class="text-xs text-granger-black opacity-60">0.6%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- End Tab 2 -->

            <!-- Tab 3: Circle Milestones -->
            <div id="tab-circle-milestones" class="tab-content hidden">
                <!-- Community -->
                <div class="shadow-sm mb-6 relative overflow-hidden" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px dashed #a5d6a7;">
                    <i data-lucide="globe" class="absolute -bottom-8 -right-8 w-48 h-48 opacity-10" style="color: #2e7d32;"></i>
                    <div class="config-group-header flex items-center justify-between px-6 py-4 relative z-10">
                        <h3 class="font-bold text-granger-black uppercase tracking-wide">Community</h3>
                        <div class="flex items-center gap-3">
                            <span class="px-2 py-0.5 text-xs font-medium rounded-full bg-white/70 text-green-700">194,436 total</span>
                            <span class="px-2 py-0.5 text-xs font-medium rounded-full bg-green-700 text-white">+ 41,194 this month</span>
                        </div>
                    </div>
                    <div id="config-group-community" class="relative z-10">
                        <table class="w-full">
                            <thead>
                                <tr class="border-t border-b border-green-200/50">
                                    <th class="text-left py-2 px-4 text-xs font-bold text-green-800 uppercase tracking-wider align-top" style="width: 400px;"><div>Milestone</div><div class="font-normal normal-case tracking-normal text-green-600/70">&nbsp;</div></th>
                                    <th class="text-right py-2 px-4 text-xs font-bold text-green-800 uppercase tracking-wider w-28 align-top"><div>Total</div><div class="font-normal normal-case tracking-normal text-green-600/70">In Circle</div></th>
                                    <th class="text-right py-2 px-4 text-xs font-bold text-green-800 uppercase tracking-wider w-28 align-top"><div>Changed</div><div class="font-normal normal-case tracking-normal text-green-600/70">This Month</div></th>
                                    <th class="text-left py-2 px-4 text-xs font-bold text-green-800 uppercase tracking-wider align-top"><div>Description</div><div class="font-normal normal-case tracking-normal text-green-600/70">&nbsp;</div></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="clickable-row hover:bg-white/30" onclick="window.open('https://my.grangerchurch.com/mp/343/1/317', '_blank')">
                                    <td class="py-3 px-4 font-semibold text-granger-black">Joined Crowd</td>
                                    <td class="py-3 px-4 text-right font-bold text-granger-black">59,758</td>
                                    <td class="py-3 px-4 text-right text-green-700 font-medium">+ 12,453</td>
                                    <td class="py-3 px-4 text-sm text-green-800/70">Contact has entered the Crowd circle</td>
                                </tr>
                                <tr class="clickable-row hover:bg-white/30" onclick="window.open('https://my.grangerchurch.com/mp/343/2/317', '_blank')">
                                    <td class="py-3 px-4 font-semibold text-granger-black">Participant Start Date</td>
                                    <td class="py-3 px-4 text-right font-bold text-granger-black">134,678</td>
                                    <td class="py-3 px-4 text-right text-green-700 font-medium">+ 28,741</td>
                                    <td class="py-3 px-4 text-sm text-green-800/70">Initial participation date recorded</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Crowd -->
                <div class="shadow-sm mb-6 relative overflow-hidden" style="background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%); border: 2px solid #a5d6a7;">
                    <i data-lucide="users" class="absolute -bottom-8 -right-8 w-48 h-48 opacity-10" style="color: #2e7d32;"></i>
                    <div class="config-group-header flex items-center justify-between px-6 py-4 relative z-10">
                        <h3 class="font-bold text-granger-black uppercase tracking-wide">Crowd</h3>
                        <div class="flex items-center gap-3">
                            <span class="px-2 py-0.5 text-xs font-medium rounded-full bg-white/70 text-green-700">74,302 total</span>
                            <span class="px-2 py-0.5 text-xs font-medium rounded-full bg-green-700 text-white">+ 14,311 this month</span>
                        </div>
                    </div>
                    <div id="config-group-crowd" class="relative z-10">
                        <table class="w-full">
                            <thead>
                                <tr class="border-t border-b border-green-300/50">
                                    <th class="text-left py-2 px-4 text-xs font-bold text-green-800 uppercase tracking-wider align-top" style="width: 400px;"><div>Milestone</div><div class="font-normal normal-case tracking-normal text-green-700/70">&nbsp;</div></th>
                                    <th class="text-right py-2 px-4 text-xs font-bold text-green-800 uppercase tracking-wider w-28 align-top"><div>Total</div><div class="font-normal normal-case tracking-normal text-green-700/70">In Circle</div></th>
                                    <th class="text-right py-2 px-4 text-xs font-bold text-green-800 uppercase tracking-wider w-28 align-top"><div>Changed</div><div class="font-normal normal-case tracking-normal text-green-700/70">This Month</div></th>
                                    <th class="text-left py-2 px-4 text-xs font-bold text-green-800 uppercase tracking-wider align-top"><div>Description</div><div class="font-normal normal-case tracking-normal text-green-700/70">&nbsp;</div></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="clickable-row hover:bg-white/30" onclick="window.open('https://my.grangerchurch.com/mp/343/3/317', '_blank')">
                                    <td class="py-3 px-4 font-semibold text-granger-black">First Life Group</td>
                                    <td class="py-3 px-4 text-right font-bold text-granger-black">5,767</td>
                                    <td class="py-3 px-4 text-right text-green-800 font-medium">+ 1,842</td>
                                    <td class="py-3 px-4 text-sm text-green-800/70">First time joining a life group</td>
                                </tr>
                                <tr class="clickable-row hover:bg-white/30" onclick="window.open('https://my.grangerchurch.com/mp/343/4/317', '_blank')">
                                    <td class="py-3 px-4 font-semibold text-granger-black">First Time Guest</td>
                                    <td class="py-3 px-4 text-right font-bold text-granger-black">2,002</td>
                                    <td class="py-3 px-4 text-right text-green-800 font-medium">+ 687</td>
                                    <td class="py-3 px-4 text-sm text-green-800/70">First visit recorded</td>
                                </tr>
                                <tr class="clickable-row hover:bg-white/30" onclick="window.open('https://my.grangerchurch.com/mp/343/5/317', '_blank')">
                                    <td class="py-3 px-4 font-semibold text-granger-black">Joined Congregation</td>
                                    <td class="py-3 px-4 text-right font-bold text-granger-black">53,392</td>
                                    <td class="py-3 px-4 text-right text-green-800 font-medium">+ 8,214</td>
                                    <td class="py-3 px-4 text-sm text-green-800/70">Contact has entered the Congregation circle</td>
                                </tr>
                                <tr class="clickable-row hover:bg-white/30" onclick="window.open('https://my.grangerchurch.com/mp/343/6/317', '_blank')">
                                    <td class="py-3 px-4 font-semibold text-granger-black">New Family Visit</td>
                                    <td class="py-3 px-4 text-right font-bold text-granger-black">363</td>
                                    <td class="py-3 px-4 text-right text-green-800 font-medium">+ 112</td>
                                    <td class="py-3 px-4 text-sm text-green-800/70">New family has visited</td>
                                </tr>
                                <tr class="clickable-row hover:bg-white/30" onclick="window.open('https://my.grangerchurch.com/mp/343/7/317', '_blank')">
                                    <td class="py-3 px-4 font-semibold text-granger-black">New-Kids Checkin</td>
                                    <td class="py-3 px-4 text-right font-bold text-granger-black">12,778</td>
                                    <td class="py-3 px-4 text-right text-green-800 font-medium">+ 3,456</td>
                                    <td class="py-3 px-4 text-sm text-green-800/70">First kids check-in recorded</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Congregation -->
                <div class="shadow-sm mb-6 relative overflow-hidden" style="background: linear-gradient(135deg, #a5d6a7 0%, #81c784 100%); border: 2px solid #81c784;">
                    <i data-lucide="church" class="absolute -bottom-8 -right-8 w-48 h-48 opacity-10" style="color: #1b5e20;"></i>
                    <div class="config-group-header flex items-center justify-between px-6 py-4 relative z-10">
                        <h3 class="font-bold text-granger-black uppercase tracking-wide">Congregation</h3>
                        <div class="flex items-center gap-3">
                            <span class="px-2 py-0.5 text-xs font-medium rounded-full bg-white/70 text-green-800">19,414 total</span>
                            <span class="px-2 py-0.5 text-xs font-medium rounded-full bg-green-800 text-white">+ 4,857 this month</span>
                        </div>
                    </div>
                    <div id="config-group-congregation" class="relative z-10">
                        <table class="w-full">
                            <thead>
                                <tr class="border-t border-b border-green-400/50">
                                    <th class="text-left py-2 px-4 text-xs font-bold text-green-900 uppercase tracking-wider align-top" style="width: 400px;"><div>Milestone</div><div class="font-normal normal-case tracking-normal text-green-800/70">&nbsp;</div></th>
                                    <th class="text-right py-2 px-4 text-xs font-bold text-green-900 uppercase tracking-wider w-28 align-top"><div>Total</div><div class="font-normal normal-case tracking-normal text-green-800/70">In Circle</div></th>
                                    <th class="text-right py-2 px-4 text-xs font-bold text-green-900 uppercase tracking-wider w-28 align-top"><div>Changed</div><div class="font-normal normal-case tracking-normal text-green-800/70">This Month</div></th>
                                    <th class="text-left py-2 px-4 text-xs font-bold text-green-900 uppercase tracking-wider align-top"><div>Description</div><div class="font-normal normal-case tracking-normal text-green-800/70">&nbsp;</div></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="clickable-row hover:bg-white/30" onclick="window.open('https://my.grangerchurch.com/mp/343/8/317', '_blank')">
                                    <td class="py-3 px-4 font-semibold text-granger-black">Baptism</td>
                                    <td class="py-3 px-4 text-right font-bold text-granger-black">8,940</td>
                                    <td class="py-3 px-4 text-right text-green-900 font-medium">+ 2,156</td>
                                    <td class="py-3 px-4 text-sm text-green-900/70">Baptism recorded</td>
                                </tr>
                                <tr class="clickable-row hover:bg-white/30" onclick="window.open('https://my.grangerchurch.com/mp/343/9/317', '_blank')">
                                    <td class="py-3 px-4 font-semibold text-granger-black">I Am Committed</td>
                                    <td class="py-3 px-4 text-right font-bold text-granger-black">2,707</td>
                                    <td class="py-3 px-4 text-right text-green-900 font-medium">+ 834</td>
                                    <td class="py-3 px-4 text-sm text-green-900/70">Commitment declaration made</td>
                                </tr>
                                <tr class="clickable-row hover:bg-white/30" onclick="window.open('https://my.grangerchurch.com/mp/343/10/317', '_blank')">
                                    <td class="py-3 px-4 font-semibold text-granger-black">I previously decided to follow Christ</td>
                                    <td class="py-3 px-4 text-right font-bold text-granger-black">2,940</td>
                                    <td class="py-3 px-4 text-right text-green-900 font-medium">+ 612</td>
                                    <td class="py-3 px-4 text-sm text-green-900/70">Prior faith decision recorded</td>
                                </tr>
                                <tr class="clickable-row hover:bg-white/30" onclick="window.open('https://my.grangerchurch.com/mp/343/11/317', '_blank')">
                                    <td class="py-3 px-4 font-semibold text-granger-black">I recently decided to follow Christ</td>
                                    <td class="py-3 px-4 text-right font-bold text-granger-black">2,882</td>
                                    <td class="py-3 px-4 text-right text-green-900 font-medium">+ 743</td>
                                    <td class="py-3 px-4 text-sm text-green-900/70">Recent faith decision recorded</td>
                                </tr>
                                <tr class="clickable-row hover:bg-white/30" onclick="window.open('https://my.grangerchurch.com/mp/343/12/317', '_blank')">
                                    <td class="py-3 px-4 font-semibold text-granger-black">New-Giving</td>
                                    <td class="py-3 px-4 text-right font-bold text-granger-black">254</td>
                                    <td class="py-3 px-4 text-right text-green-900 font-medium">+ 89</td>
                                    <td class="py-3 px-4 text-sm text-green-900/70">First giving recorded</td>
                                </tr>
                                <tr class="clickable-row hover:bg-white/30" onclick="window.open('https://my.grangerchurch.com/mp/343/13/317', '_blank')">
                                    <td class="py-3 px-4 font-semibold text-granger-black">Rededication</td>
                                    <td class="py-3 px-4 text-right font-bold text-granger-black">1,691</td>
                                    <td class="py-3 px-4 text-right text-green-900 font-medium">+ 423</td>
                                    <td class="py-3 px-4 text-sm text-green-900/70">Rededication of faith</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Committed -->
                <div class="shadow-sm mb-6 relative overflow-hidden" style="background: linear-gradient(135deg, #81c784 0%, #66bb6a 100%); border: 2px solid #66bb6a;">
                    <i data-lucide="heart-handshake" class="absolute -bottom-8 -right-8 w-48 h-48 opacity-10" style="color: #1b5e20;"></i>
                    <div class="config-group-header flex items-center justify-between px-6 py-4 relative z-10">
                        <h3 class="font-bold text-white uppercase tracking-wide">Committed</h3>
                        <div class="flex items-center gap-3">
                            <span class="px-2 py-0.5 text-xs font-medium rounded-full bg-white/70 text-green-800">51,539 total</span>
                            <span class="px-2 py-0.5 text-xs font-medium rounded-full bg-green-900 text-white">+ 8,412 this month</span>
                        </div>
                    </div>
                    <div id="config-group-committed" class="relative z-10">
                        <table class="w-full">
                            <thead>
                                <tr class="border-t border-b border-green-500/50">
                                    <th class="text-left py-2 px-4 text-xs font-bold text-white uppercase tracking-wider align-top" style="width: 400px;"><div>Milestone</div><div class="font-normal normal-case tracking-normal text-white/70">&nbsp;</div></th>
                                    <th class="text-right py-2 px-4 text-xs font-bold text-white uppercase tracking-wider w-28 align-top"><div>Total</div><div class="font-normal normal-case tracking-normal text-white/70">In Circle</div></th>
                                    <th class="text-right py-2 px-4 text-xs font-bold text-white uppercase tracking-wider w-28 align-top"><div>Changed</div><div class="font-normal normal-case tracking-normal text-white/70">This Month</div></th>
                                    <th class="text-left py-2 px-4 text-xs font-bold text-white uppercase tracking-wider align-top"><div>Description</div><div class="font-normal normal-case tracking-normal text-white/70">&nbsp;</div></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="clickable-row hover:bg-white/20" onclick="window.open('https://my.grangerchurch.com/mp/343/14/317', '_blank')">
                                    <td class="py-3 px-4 font-semibold text-white">Joined Committed</td>
                                    <td class="py-3 px-4 text-right font-bold text-white">50,044</td>
                                    <td class="py-3 px-4 text-right text-green-100 font-medium">+ 11,231</td>
                                    <td class="py-3 px-4 text-sm text-white/80">Contact has entered the Committed circle</td>
                                </tr>
                                <tr class="clickable-row hover:bg-white/20" onclick="window.open('https://my.grangerchurch.com/mp/343/15/317', '_blank')">
                                    <td class="py-3 px-4 font-semibold text-white">Began Serving</td>
                                    <td class="py-3 px-4 text-right font-bold text-white">50,036</td>
                                    <td class="py-3 px-4 text-right text-green-100 font-medium">+ 9,847</td>
                                    <td class="py-3 px-4 text-sm text-white/80">Started serving in a ministry</td>
                                </tr>
                                <tr class="clickable-row hover:bg-white/20" onclick="window.open('https://my.grangerchurch.com/mp/343/16/317', '_blank')">
                                    <td class="py-3 px-4 font-semibold text-white">Membership</td>
                                    <td class="py-3 px-4 text-right font-bold text-white">1,115</td>
                                    <td class="py-3 px-4 text-right text-green-100 font-medium">+ 287</td>
                                    <td class="py-3 px-4 text-sm text-white/80">Became a church member</td>
                                </tr>
                                <tr class="clickable-row hover:bg-white/20" onclick="window.open('https://my.grangerchurch.com/mp/343/17/317', '_blank')">
                                    <td class="py-3 px-4 font-semibold text-white">S.H.A.P.E. Covenant</td>
                                    <td class="py-3 px-4 text-right font-bold text-white">344</td>
                                    <td class="py-3 px-4 text-right text-green-100 font-medium">+ 124</td>
                                    <td class="py-3 px-4 text-sm text-white/80">Completed S.H.A.P.E. covenant</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Core -->
                <div class="shadow-sm mb-6 relative overflow-hidden" style="background: linear-gradient(135deg, #AAD43C 0%, #8bc34a 100%); border: 2px solid #7da32d;">
                    <i data-lucide="star" class="absolute -bottom-8 -right-8 w-48 h-48 opacity-15" style="color: #5a7a1f;"></i>
                    <div class="config-group-header flex items-center justify-between px-6 py-4 relative z-10">
                        <h3 class="font-bold text-white uppercase tracking-wide">Core</h3>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="px-2 py-0.5 text-xs font-medium rounded-full bg-white/70 text-green-800">2,485 total</span>
                            <span class="px-2 py-0.5 text-xs font-medium rounded-full" style="background-color: #5a7a1f; color: white;">+ 1,283 this month</span>
                        </div>
                    </div>
                    <div id="config-group-core" class="relative z-10">
                        <table class="w-full">
                            <thead>
                                <tr class="border-t border-b" style="border-color: rgba(125, 163, 45, 0.5);">
                                    <th class="text-left py-2 px-4 text-xs font-bold text-white uppercase tracking-wider align-top" style="width: 400px;"><div>Milestone</div><div class="font-normal normal-case tracking-normal text-white/70">&nbsp;</div></th>
                                    <th class="text-right py-2 px-4 text-xs font-bold text-white uppercase tracking-wider w-28 align-top"><div>Total</div><div class="font-normal normal-case tracking-normal text-white/70">In Circle</div></th>
                                    <th class="text-right py-2 px-4 text-xs font-bold text-white uppercase tracking-wider w-28 align-top"><div>Changed</div><div class="font-normal normal-case tracking-normal text-white/70">This Month</div></th>
                                    <th class="text-left py-2 px-4 text-xs font-bold text-white uppercase tracking-wider align-top"><div>Description</div><div class="font-normal normal-case tracking-normal text-white/70">&nbsp;</div></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="clickable-row hover:bg-white/20" onclick="window.open('https://my.grangerchurch.com/mp/343/18/317', '_blank')">
                                    <td class="py-3 px-4 font-semibold text-white">Joined Core</td>
                                    <td class="py-3 px-4 text-right font-bold text-white">1,136</td>
                                    <td class="py-3 px-4 text-right font-medium" style="color: #e8f5e9;">+ 826</td>
                                    <td class="py-3 px-4 text-sm text-white/80">Contact has entered the Core circle</td>
                                </tr>
                                <tr class="clickable-row hover:bg-white/20" onclick="window.open('https://my.grangerchurch.com/mp/343/19/317', '_blank')">
                                    <td class="py-3 px-4 font-semibold text-white">Began Leading</td>
                                    <td class="py-3 px-4 text-right font-bold text-white">866</td>
                                    <td class="py-3 px-4 text-right font-medium" style="color: #e8f5e9;">+ 312</td>
                                    <td class="py-3 px-4 text-sm text-white/80">Started in a leadership role</td>
                                </tr>
                                <tr class="clickable-row hover:bg-white/20" onclick="window.open('https://my.grangerchurch.com/mp/343/20/317', '_blank')">
                                    <td class="py-3 px-4 font-semibold text-white">Core 401 Graduate</td>
                                    <td class="py-3 px-4 text-right font-bold text-white">483</td>
                                    <td class="py-3 px-4 text-right font-medium" style="color: #e8f5e9;">+ 156</td>
                                    <td class="py-3 px-4 text-sm text-white/80">Completed Core 401 class</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div><!-- End Tab 3 -->

        </main>
    </div>

    <!-- Circle Detail Modal -->
    <div id="circleModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="if(event.target === this) closeCircleModal()">
        <div class="bg-white max-w-lg w-full shadow-2xl relative max-h-[90vh] overflow-y-auto">
            <button onclick="closeCircleModal()" class="absolute top-6 right-6 text-gray-400 hover:text-gray-600 transition z-10">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>

            <div class="p-8">
                <!-- Modal Header -->
                <div class="mb-8">
                    <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Circle Details</div>
                    <h2 id="modalTitle" class="text-3xl font-bold text-granger-black uppercase tracking-tight">Committed</h2>
                    <p id="modalDescription" class="text-gray-500 mt-1">People maturing in their faith through prayer, giving, and training</p>
                </div>

                <!-- Engagement Donut Chart -->
                <div class="flex justify-center">
                    <div style="width: 300px; height: 300px;">
                        <canvas id="engagementChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Custom Chart.js plugin to create HTML circle indicators with Lucide icons at top of bars
        const circleTopPlugin = {
            id: 'circleTop',
            afterRender(chart) {
                if (!chart.options.plugins.circleTop?.enabled) return;

                const canvas = chart.canvas;
                const container = canvas.parentElement;

                // Remove existing circle icons for this chart
                container.querySelectorAll('.chart-circle-icon').forEach(el => el.remove());

                // Make container position relative for absolute positioning
                if (getComputedStyle(container).position === 'static') {
                    container.style.position = 'relative';
                }

                const meta = chart.getDatasetMeta(chart.data.datasets.length - 1); // Get top dataset
                const circleStyles = [
                    { bg: 'rgba(200, 230, 201, 0.3)', border: '#a5d6a7', dashed: true, iconColor: '#66bb6a', icon: 'globe' },      // Community
                    { bg: '#c8e6c9', border: '#a5d6a7', dashed: false, iconColor: '#4a7c4e', icon: 'users' },                       // Crowd
                    { bg: '#a5d6a7', border: '#81c784', dashed: false, iconColor: '#3d6b40', icon: 'church' },                      // Congregation
                    { bg: '#81c784', border: '#66bb6a', dashed: false, iconColor: '#ffffff', icon: 'heart-handshake' },             // Committed
                    { bg: '#AAD43C', border: '#7da32d', dashed: false, iconColor: '#ffffff', icon: 'star' }                         // Core
                ];

                meta.data.forEach((bar, index) => {
                    const style = circleStyles[index];
                    if (!style) return;

                    const x = bar.x;
                    const y = bar.y;
                    const size = 24; // Circle size in pixels

                    // Create circle element
                    const circleEl = document.createElement('div');
                    circleEl.className = 'chart-circle-icon';
                    circleEl.style.cssText = `
                        position: absolute;
                        left: ${x - size/2}px;
                        top: ${y - size - 8}px;
                        width: ${size}px;
                        height: ${size}px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        background-color: ${style.bg};
                        border: 2px ${style.dashed ? 'dashed' : 'solid'} ${style.border};
                        pointer-events: none;
                    `;

                    // Create icon element
                    const iconEl = document.createElement('i');
                    iconEl.setAttribute('data-lucide', style.icon);
                    iconEl.style.cssText = `width: 12px; height: 12px; color: ${style.iconColor};`;
                    circleEl.appendChild(iconEl);

                    container.appendChild(circleEl);
                });

                // Re-initialize Lucide icons for the new elements
                lucide.createIcons();
            }
        };
        Chart.register(circleTopPlugin);

        // Circle data for modal
        const circleData = {
            community: {
                title: 'Community',
                description: 'The unchurched in the immediate area - your starting point and hottest prospects',
                total: '6,274',
                engaged: '1,254',
                partial: '2,891',
                lapsing: '2,129',
                milestones: [
                    { icon: 'users', name: 'Joined Crowd', count: '59,758' },
                    { icon: 'calendar', name: 'Participant Start Date', count: '134,678' }
                ],
                campuses: [
                    { name: 'Granger Campus', count: '4,521' },
                    { name: 'Elkhart Campus', count: '982' },
                    { name: 'South Bend', count: '534' },
                    { name: 'Mishawaka', count: '237' }
                ]
            },
            crowd: {
                title: 'Crowd',
                description: 'Everyone who shows up - regular service attendees',
                total: '1,344',
                engaged: '412',
                partial: '623',
                lapsing: '309',
                milestones: [
                    { icon: 'users', name: 'First Life Group', count: '5,767' },
                    { icon: 'user-check', name: 'First Time Guest', count: '2,002' },
                    { icon: 'log-in', name: 'Joined Congregation', count: '53,392' },
                    { icon: 'home', name: 'New Family Visit', count: '363' },
                    { icon: 'baby', name: 'New-Kids Checkin', count: '12,778' }
                ],
                campuses: [
                    { name: 'Granger Campus', count: '923' },
                    { name: 'Elkhart Campus', count: '241' },
                    { name: 'South Bend', count: '112' },
                    { name: 'Mishawaka', count: '68' }
                ]
            },
            congregation: {
                title: 'Congregation',
                description: 'Official members of the church with a sense of ownership',
                total: '520',
                engaged: '187',
                partial: '214',
                lapsing: '119',
                milestones: [
                    { icon: 'droplet', name: 'Baptism', count: '8,940' },
                    { icon: 'heart', name: 'I Am Committed', count: '2,707' },
                    { icon: 'cross', name: 'I previously decided to follow Christ', count: '2,940' },
                    { icon: 'sparkles', name: 'I recently decided to follow Christ', count: '2,882' },
                    { icon: 'gift', name: 'New-Giving', count: '254' },
                    { icon: 'rotate-ccw', name: 'Rededication', count: '1,691' }
                ],
                campuses: [
                    { name: 'Granger Campus', count: '356' },
                    { name: 'Elkhart Campus', count: '98' },
                    { name: 'South Bend', count: '42' },
                    { name: 'Mishawaka', count: '24' }
                ]
            },
            committed: {
                title: 'Committed',
                description: 'People who pray, give, and are dedicated to growing in discipleship',
                total: '11,231',
                engaged: '2,847',
                partial: '5,123',
                lapsing: '3,261',
                milestones: [
                    { icon: 'flag', name: 'Joined Committed', count: '50,044' },
                    { icon: 'hand-helping', name: 'Began Serving', count: '50,036' },
                    { icon: 'id-card', name: 'Membership', count: '1,115' },
                    { icon: 'shapes', name: 'S.H.A.P.E. Covenant', count: '344' }
                ],
                campuses: [
                    { name: 'Granger Campus', count: '8,456' },
                    { name: 'Elkhart Campus', count: '1,892' },
                    { name: 'South Bend', count: '645' },
                    { name: 'Mishawaka', count: '238' }
                ]
            },
            core: {
                title: 'Core',
                description: 'Ministers and leaders - without these people the church would come to a standstill',
                total: '826',
                engaged: '624',
                partial: '156',
                lapsing: '46',
                milestones: [
                    { icon: 'flag', name: 'Joined Core', count: '1,136' },
                    { icon: 'megaphone', name: 'Began Leading', count: '866' },
                    { icon: 'award', name: 'Core 401 Graduate', count: '483' }
                ],
                campuses: [
                    { name: 'Granger Campus', count: '612' },
                    { name: 'Elkhart Campus', count: '134' },
                    { name: 'South Bend', count: '52' },
                    { name: 'Mishawaka', count: '28' }
                ]
            }
        };

        function openCircleModal(circle) {
            const data = circleData[circle];
            if (!data) return;

            document.getElementById('modalTitle').textContent = data.title;
            document.getElementById('modalDescription').textContent = data.description;

            document.getElementById('circleModal').classList.remove('hidden');

            // Parse engagement numbers
            const engagedNum = parseInt(data.engaged.replace(/,/g, ''));
            const partialNum = parseInt(data.partial.replace(/,/g, ''));
            const lapsingNum = parseInt(data.lapsing.replace(/,/g, ''));

            // Store values for closure
            const chartData = {
                engaged: data.engaged,
                partial: data.partial,
                lapsing: data.lapsing,
                engagedNum: engagedNum,
                partialNum: partialNum,
                lapsingNum: lapsingNum
            };

            // Use setTimeout to ensure DOM has painted
            setTimeout(function() {
                try {
                    if (window.engagementChart && typeof window.engagementChart.destroy === 'function') {
                        window.engagementChart.destroy();
                    }
                    window.engagementChart = null;

                    const canvas = document.getElementById('engagementChart');
                    if (!canvas) {
                        console.error('Canvas not found');
                        return;
                    }

                    console.log('Creating chart with data:', chartData);

                    window.engagementChart = new Chart(canvas, {
                        type: 'doughnut',
                        data: {
                            labels: [
                                'Fully Engaged (' + chartData.engaged + ')',
                                'Partially Engaged (' + chartData.partial + ')',
                                'Lapsing (' + chartData.lapsing + ')'
                            ],
                            datasets: [{
                                data: [chartData.engagedNum, chartData.partialNum, chartData.lapsingNum],
                                backgroundColor: ['#AAD43C', '#eab308', '#ef4444'],
                                borderColor: ['#ffffff', '#ffffff', '#ffffff'],
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            cutout: '50%',
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 20,
                                        font: {
                                            family: 'Poppins',
                                            size: 13,
                                            weight: '600'
                                        }
                                    }
                                }
                            }
                        }
                    });
                    console.log('Chart created successfully');
                } catch (e) {
                    console.error('Chart error:', e);
                }
            }, 150);

            lucide.createIcons();
        }

        function closeCircleModal() {
            document.getElementById('circleModal').classList.add('hidden');
        }

        // Initialize Lucide icons
        lucide.createIcons();

        // Trends Chart
        const ctx = document.getElementById('trendsChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov'],
                datasets: [
                    {
                        label: 'Community',
                        data: [7372, 7132, 6814, 6487, 6249, 5991, 5804, 5564, 5460, 5359, 5254],
                        borderColor: '#c8e6c9',
                        backgroundColor: 'rgba(200, 230, 201, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: false
                    },
                    {
                        label: 'Crowd',
                        data: [845, 834, 861, 931, 980, 1001, 1016, 1086, 1166, 1230, 1257],
                        borderColor: '#a5d6a7',
                        backgroundColor: 'rgba(165, 214, 167, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: false
                    },
                    {
                        label: 'Congregation',
                        data: [362, 335, 326, 351, 357, 413, 410, 400, 417, 451, 523],
                        borderColor: '#81c784',
                        backgroundColor: 'rgba(129, 199, 132, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: false
                    },
                    {
                        label: 'Committed',
                        data: [9789, 10067, 10365, 10594, 10777, 10901, 11063, 11236, 11243, 11246, 11249],
                        borderColor: '#66bb6a',
                        backgroundColor: 'rgba(102, 187, 106, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: false
                    },
                    {
                        label: 'Core',
                        data: [714, 714, 716, 719, 719, 776, 789, 796, 796, 796, 799],
                        borderColor: '#AAD43C',
                        backgroundColor: 'rgba(170, 212, 60, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            font: {
                                family: 'Poppins',
                                size: 11
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                family: 'Poppins',
                                size: 11
                            }
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });

        // In Chart
        const inCtx = document.getElementById('inChart').getContext('2d');
        new Chart(inCtx, {
            type: 'bar',
            data: {
                labels: ['Community', 'Crowd', 'Congregation', 'Committed', 'Core'],
                datasets: [{
                    label: 'People in Circle',
                    data: [6274, 1344, 520, 11231, 826],
                    backgroundColor: [
                        '#c8e6c9',
                        '#a5d6a7',
                        '#81c784',
                        '#66bb6a',
                        '#AAD43C'
                    ],
                    borderColor: [
                        '#c8e6c9',
                        '#a5d6a7',
                        '#81c784',
                        '#66bb6a',
                        '#AAD43C'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: { top: 25 }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    circleTop: {
                        enabled: true
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            font: {
                                family: 'Poppins',
                                size: 11
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                family: 'Poppins',
                                size: 10
                            }
                        }
                    }
                }
            }
        });

        // Circle hover effects
        document.querySelectorAll('.circle').forEach(circle => {
            circle.addEventListener('mouseenter', function() {
                const level = this.dataset.level;
                // Could show a tooltip or highlight related data
            });
        });

        // Tab Switching
        function switchTab(tabId) {
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            // Remove active from all buttons
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            // Show selected tab
            document.getElementById('tab-' + tabId).classList.remove('hidden');
            // Mark button as active
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');

            // Initialize participants charts when that tab is selected
            if (tabId === 'circle-participants') {
                initParticipantsCharts();
            }
            // Refresh icons for milestones tab
            if (tabId === 'circle-milestones') {
                lucide.createIcons();
            }
        }

        // Participants Charts - track instances to destroy on re-init
        let participantsCharts = {};

        function initParticipantsCharts() {
            // Destroy existing charts
            Object.values(participantsCharts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            participantsCharts = {};

            const circleColors = ['#c8e6c9', '#a5d6a7', '#81c784', '#66bb6a', '#AAD43C'];
            const engagementColors = ['#AAD43C', '#eab308', '#f97316', '#3b82f6', '#ef4444'];

            // Distribution Chart (Doughnut)
            participantsCharts.circle = new Chart(document.getElementById('participantsCircleChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Community', 'Crowd', 'Congregation', 'Committed', 'Core'],
                    datasets: [{
                        data: [6274, 1344, 520, 11231, 826],
                        backgroundColor: circleColors,
                        borderColor: '#ffffff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });

            // Engagement (Stacked Bar)
            participantsCharts.engagementByCircle = new Chart(document.getElementById('engagementByCircleChart'), {
                type: 'bar',
                data: {
                    labels: ['Community', 'Crowd', 'Congregation', 'Committed', 'Core'],
                    datasets: [
                        {
                            label: 'Fully Engaged',
                            data: [1254, 412, 187, 2847, 624],
                            backgroundColor: '#AAD43C'
                        },
                        {
                            label: 'Partially Engaged',
                            data: [2891, 623, 214, 5123, 156],
                            backgroundColor: '#eab308'
                        },
                        {
                            label: 'Lapsing',
                            data: [1200, 200, 80, 2100, 35],
                            backgroundColor: '#f97316'
                        },
                        {
                            label: 'Observing',
                            data: [500, 80, 25, 800, 8],
                            backgroundColor: '#3b82f6'
                        },
                        {
                            label: 'Lapsed',
                            data: [429, 29, 14, 361, 3],
                            backgroundColor: '#ef4444'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: { top: 25 } },
                    scales: {
                        x: { stacked: true, grid: { display: false }, ticks: { font: { size: 10 } } },
                        y: { stacked: true, grid: { color: 'rgba(0,0,0,0.05)' } }
                    },
                    plugins: { legend: { display: false }, circleTop: { enabled: true } }
                }
            });

            // Participant Type Chart (Circles on X-axis, Participant Types stacked)
            participantsCharts.participantType = new Chart(document.getElementById('participantTypeChart'), {
                type: 'bar',
                data: {
                    labels: ['Community', 'Crowd', 'Congregation', 'Committed', 'Core'],
                    datasets: [
                        { label: 'Church Family', data: [1200, 1800, 950, 7200, 1392], backgroundColor: '#3b82f6' },
                        { label: 'Attendee', data: [800, 620, 410, 2100, 301], backgroundColor: '#6366f1' },
                        { label: 'New', data: [450, 380, 290, 580, 123], backgroundColor: '#8b5cf6' },
                        { label: 'MC3 Neighbor', data: [320, 210, 125, 180, 41], backgroundColor: '#a855f7' },
                        { label: 'Non-Attending', data: [180, 95, 68, 145, 24], backgroundColor: '#d946ef' },
                        { label: 'Dropped', data: [85, 42, 28, 48, 8], backgroundColor: '#ec4899' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: { top: 25 } },
                    plugins: { legend: { display: false }, circleTop: { enabled: true } },
                    scales: {
                        x: { stacked: true, grid: { display: false }, ticks: { font: { size: 10 } } },
                        y: { stacked: true, grid: { color: 'rgba(0,0,0,0.05)' } }
                    }
                }
            });

            // Household Position Chart (Circles on X-axis, Household Positions stacked)
            participantsCharts.householdPosition = new Chart(document.getElementById('householdPositionChart'), {
                type: 'bar',
                data: {
                    labels: ['Community', 'Crowd', 'Congregation', 'Committed', 'Core'],
                    datasets: [
                        { label: 'Head of Household', data: [1400, 1200, 820, 4800, 714], backgroundColor: '#f97316' },
                        { label: 'Minor Child', data: [1100, 950, 680, 2500, 391], backgroundColor: '#fb923c' },
                        { label: 'Other Adult', data: [620, 480, 390, 1520, 202], backgroundColor: '#fbbf24' },
                        { label: 'Adult Child', data: [380, 320, 245, 820, 111], backgroundColor: '#facc15' },
                        { label: 'Guest Child', data: [150, 95, 62, 98, 18], backgroundColor: '#a3e635' },
                        { label: 'Company', data: [45, 32, 18, 28, 6], backgroundColor: '#4ade80' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: { top: 25 } },
                    plugins: { legend: { display: false }, circleTop: { enabled: true } },
                    scales: {
                        x: { stacked: true, grid: { display: false }, ticks: { font: { size: 10 } } },
                        y: { stacked: true, grid: { color: 'rgba(0,0,0,0.05)' } }
                    }
                }
            });
        }

        // Participant Chart Data (shared across chart types)
        // X-axis: Circles, Stacked: Participant Types
        const participantChartData = {
            labels: ['Community', 'Crowd', 'Congregation', 'Committed', 'Core'],
            categories: ['Church Family', 'Attendee', 'New', 'MC3 Neighbor', 'Non-Attending', 'Dropped'],
            colors: ['#3b82f6', '#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899'],
            values: [
                [1200, 1800, 950, 7200, 1392],   // Church Family
                [800, 620, 410, 2100, 301],      // Attendee
                [450, 380, 290, 580, 123],       // New
                [320, 210, 125, 180, 41],        // MC3 Neighbor
                [180, 95, 68, 145, 24],          // Non-Attending
                [85, 42, 28, 48, 8]              // Dropped
            ]
        };

        // Switch Participant Chart Type
        function switchParticipantChart(type) {
            // Update button states
            document.querySelectorAll('.chart-type-btn[data-chart-group="participant"]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.chart === type);
            });

            // Destroy existing chart
            if (participantsCharts.participantType) {
                participantsCharts.participantType.destroy();
            }

            const ctx = document.getElementById('participantTypeChart');
            // Ensure canvas is visible (may be hidden by matrix view)
            ctx.style.display = 'block';
            // Remove matrix heatmap if present
            const existingMatrix = ctx.parentElement.querySelector('.matrix-heatmap');
            if (existingMatrix) existingMatrix.remove();

            // Show/hide custom legend and axis labels
            document.getElementById('participant-legend').style.display = (type === 'matrix') ? 'none' : 'grid';

            const data = participantChartData;

            if (type === 'stacked') {
                // Stacked Bar Chart
                participantsCharts.participantType = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: data.categories.map((cat, i) => ({
                            label: cat,
                            data: data.values[i],
                            backgroundColor: data.colors[i]
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: { padding: { top: 25 } },
                        plugins: { legend: { display: false }, circleTop: { enabled: true } },
                        scales: {
                            x: { stacked: true, grid: { display: false }, ticks: { font: { size: 10 } } },
                            y: { stacked: true, grid: { color: 'rgba(0,0,0,0.05)' } }
                        }
                    }
                });
            } else if (type === 'percent') {
                // 100% Stacked Bar Chart
                const totals = data.labels.map((_, colIdx) =>
                    data.values.reduce((sum, row) => sum + row[colIdx], 0)
                );
                participantsCharts.participantType = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: data.categories.map((cat, i) => ({
                            label: cat,
                            data: data.values[i].map((val, colIdx) => (val / totals[colIdx]) * 100),
                            backgroundColor: data.colors[i]
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: { padding: { top: 25 } },
                        plugins: {
                            legend: { display: false },
                            circleTop: { enabled: true },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => `${ctx.dataset.label}: ${ctx.raw.toFixed(1)}%`
                                }
                            }
                        },
                        scales: {
                            x: { stacked: true, grid: { display: false }, ticks: { font: { size: 10 } } },
                            y: { stacked: true, max: 100, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { callback: v => v + '%' } }
                        }
                    }
                });
            } else if (type === 'grouped') {
                // Grouped Bar Chart
                participantsCharts.participantType = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: data.categories.map((cat, i) => ({
                            label: cat,
                            data: data.values[i],
                            backgroundColor: data.colors[i]
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: { padding: { top: 25 } },
                        plugins: { legend: { display: false }, circleTop: { enabled: true } },
                        scales: {
                            x: { grid: { display: false }, ticks: { font: { size: 10 } } },
                            y: { grid: { color: 'rgba(0,0,0,0.05)' } }
                        }
                    }
                });
            } else if (type === 'matrix') {
                // Matrix Heatmap - categories as rows, circles as columns
                const maxVal = Math.max(...data.values.flat());
                const container = ctx.parentElement;
                ctx.style.display = 'none';

                // Remove existing matrix if present
                const existingMatrix = container.querySelector('.matrix-heatmap');
                if (existingMatrix) existingMatrix.remove();

                const matrix = document.createElement('div');
                matrix.className = 'matrix-heatmap';
                matrix.style.cssText = 'display: grid; grid-template-columns: 110px repeat(' + data.labels.length + ', 1fr); gap: 2px; height: 100%; font-size: 9px;';

                // Header row (circles)
                matrix.innerHTML = '<div></div>' + data.labels.map(l => `<div style="text-align: center; font-weight: 600; padding: 4px; overflow: hidden; text-overflow: ellipsis;">${l}</div>`).join('');

                // Data rows (categories)
                data.categories.forEach((cat, rowIdx) => {
                    matrix.innerHTML += `<div style="display: flex; align-items: center; font-weight: 600; font-size: 8px;">${cat}</div>`;
                    data.values[rowIdx].forEach(val => {
                        const intensity = Math.pow(val / maxVal, 0.5);
                        // Blue/purple gradient for participant types
                        const r = Math.round(220 - (intensity * 161));
                        const g = Math.round(220 - (intensity * 90));
                        const b = Math.round(255 - (intensity * 9));
                        matrix.innerHTML += `<div style="background: rgb(${r},${g},${b}); display: flex; align-items: center; justify-content: center; font-weight: 500; color: ${intensity > 0.5 ? '#fff' : '#333'};" title="${val.toLocaleString()}">${val >= 1000 ? (val/1000).toFixed(1) + 'k' : val}</div>`;
                    });
                });

                container.appendChild(matrix);
                // Store reference for cleanup
                participantsCharts.participantType = { destroy: () => { matrix.remove(); ctx.style.display = 'block'; } };
            }
        }

        // Engagement Chart Data (labels are circles, datasets are engagement levels)
        const engagementChartData = {
            labels: ['Community', 'Crowd', 'Congregation', 'Committed', 'Core'],
            categories: ['Fully Engaged', 'Partially Engaged', 'Lapsing', 'Observing', 'Lapsed'],
            colors: ['#AAD43C', '#eab308', '#f97316', '#3b82f6', '#ef4444'],
            values: [
                [1254, 412, 187, 2847, 624],    // Fully Engaged
                [2891, 623, 214, 5123, 156],    // Partially Engaged
                [1200, 200, 80, 2100, 35],      // Lapsing
                [500, 80, 25, 800, 8],          // Observing
                [429, 29, 14, 361, 3]           // Lapsed
            ]
        };

        // Switch Engagement Chart Type
        function switchEngagementChart(type) {
            // Update button states
            document.querySelectorAll('.chart-type-btn[data-chart-group="engagement"]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.chart === type);
            });

            // Destroy existing chart
            if (participantsCharts.engagementByCircle) {
                participantsCharts.engagementByCircle.destroy();
            }

            const ctx = document.getElementById('engagementByCircleChart');
            // Ensure canvas is visible (may be hidden by matrix view)
            ctx.style.display = 'block';
            // Remove matrix heatmap if present
            const existingMatrix = ctx.parentElement.querySelector('.matrix-heatmap');
            if (existingMatrix) existingMatrix.remove();

            const data = engagementChartData;

            // Show custom legend and axis labels for non-matrix views
            document.getElementById('engagement-legend').style.display = (type === 'matrix') ? 'none' : 'grid';

            if (type === 'stacked') {
                participantsCharts.engagementByCircle = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: data.categories.map((cat, i) => ({
                            label: cat,
                            data: data.values[i],
                            backgroundColor: data.colors[i]
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: { padding: { top: 25 } },
                        plugins: { legend: { display: false }, circleTop: { enabled: true } },
                        scales: {
                            x: { stacked: true, grid: { display: false }, ticks: { font: { size: 10 } } },
                            y: { stacked: true, grid: { color: 'rgba(0,0,0,0.05)' } }
                        }
                    }
                });
            } else if (type === 'percent') {
                const totals = data.labels.map((_, colIdx) =>
                    data.values.reduce((sum, row) => sum + row[colIdx], 0)
                );
                participantsCharts.engagementByCircle = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: data.categories.map((cat, i) => ({
                            label: cat,
                            data: data.values[i].map((val, colIdx) => (val / totals[colIdx]) * 100),
                            backgroundColor: data.colors[i]
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: { padding: { top: 25 } },
                        plugins: {
                            legend: { display: false },
                            circleTop: { enabled: true },
                            tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${ctx.raw.toFixed(1)}%` } }
                        },
                        scales: {
                            x: { stacked: true, grid: { display: false }, ticks: { font: { size: 10 } } },
                            y: { stacked: true, max: 100, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { callback: v => v + '%' } }
                        }
                    }
                });
            } else if (type === 'grouped') {
                participantsCharts.engagementByCircle = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: data.categories.map((cat, i) => ({
                            label: cat,
                            data: data.values[i],
                            backgroundColor: data.colors[i]
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: { padding: { top: 25 } },
                        plugins: { legend: { display: false }, circleTop: { enabled: true } },
                        scales: {
                            x: { grid: { display: false }, ticks: { font: { size: 10 } } },
                            y: { grid: { color: 'rgba(0,0,0,0.05)' } }
                        }
                    }
                });
            } else if (type === 'matrix') {
                // Matrix Heatmap - categories as rows, circles as columns
                const maxVal = Math.max(...data.values.flat());
                const container = ctx.parentElement;
                ctx.style.display = 'none';

                const existingMatrix = container.querySelector('.matrix-heatmap');
                if (existingMatrix) existingMatrix.remove();

                const matrix = document.createElement('div');
                matrix.className = 'matrix-heatmap';
                matrix.style.cssText = 'display: grid; grid-template-columns: 120px repeat(' + data.labels.length + ', 1fr); gap: 2px; height: 100%; font-size: 9px;';

                // Header row (circles)
                matrix.innerHTML = '<div></div>' + data.labels.map(l => `<div style="text-align: center; font-weight: 600; padding: 4px;">${l}</div>`).join('');

                // Data rows (engagement categories)
                data.categories.forEach((cat, rowIdx) => {
                    matrix.innerHTML += `<div style="display: flex; align-items: center; font-weight: 600; color: ${data.colors[rowIdx]};">${cat}</div>`;
                    data.values[rowIdx].forEach(val => {
                        const intensity = Math.pow(val / maxVal, 0.5);
                        const r = Math.round(200 - (intensity * 110));
                        const g = Math.round(245 - (intensity * 57));
                        const b = Math.round(200 - (intensity * 140));
                        matrix.innerHTML += `<div style="background: rgb(${r},${g},${b}); display: flex; align-items: center; justify-content: center; font-weight: 500; color: ${intensity > 0.5 ? '#fff' : '#333'};" title="${val.toLocaleString()}">${val >= 1000 ? (val/1000).toFixed(1) + 'k' : val}</div>`;
                    });
                });

                container.appendChild(matrix);
                participantsCharts.engagementByCircle = { destroy: () => { matrix.remove(); ctx.style.display = 'block'; } };
            }
        }

        // Demographics Chart Data (same structure as participant chart)
        // Demographics Chart Data (shared across chart types)
        // X-axis: Circles, Stacked: Household Positions
        const demographicsChartData = {
            labels: ['Community', 'Crowd', 'Congregation', 'Committed', 'Core'],
            categories: ['Head of Household', 'Minor Child', 'Other Adult', 'Adult Child', 'Guest Child', 'Company'],
            colors: ['#f97316', '#fb923c', '#fbbf24', '#facc15', '#a3e635', '#4ade80'],
            values: [
                [1400, 1200, 820, 4800, 714],    // Head of Household
                [1100, 950, 680, 2500, 391],     // Minor Child
                [620, 480, 390, 1520, 202],      // Other Adult
                [380, 320, 245, 820, 111],       // Adult Child
                [150, 95, 62, 98, 18],           // Guest Child
                [45, 32, 18, 28, 6]              // Company
            ]
        };

        // Switch Demographics Chart Type
        function switchDemographicsChart(type) {
            // Update button states
            document.querySelectorAll('.chart-type-btn[data-chart-group="demographics"]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.chart === type);
            });

            // Destroy existing chart
            if (participantsCharts.householdPosition) {
                participantsCharts.householdPosition.destroy();
            }

            const ctx = document.getElementById('householdPositionChart');
            // Ensure canvas is visible (may be hidden by matrix view)
            ctx.style.display = 'block';
            // Remove matrix heatmap if present
            const existingMatrix = ctx.parentElement.querySelector('.matrix-heatmap');
            if (existingMatrix) existingMatrix.remove();

            // Show/hide custom legend and axis labels
            document.getElementById('demographics-legend').style.display = (type === 'matrix') ? 'none' : 'grid';

            const data = demographicsChartData;

            if (type === 'stacked') {
                participantsCharts.householdPosition = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: data.categories.map((cat, i) => ({
                            label: cat,
                            data: data.values[i],
                            backgroundColor: data.colors[i]
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: { padding: { top: 25 } },
                        plugins: { legend: { display: false }, circleTop: { enabled: true } },
                        scales: {
                            x: { stacked: true, grid: { display: false }, ticks: { font: { size: 10 } } },
                            y: { stacked: true, grid: { color: 'rgba(0,0,0,0.05)' } }
                        }
                    }
                });
            } else if (type === 'percent') {
                const totals = data.labels.map((_, colIdx) =>
                    data.values.reduce((sum, row) => sum + row[colIdx], 0)
                );
                participantsCharts.householdPosition = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: data.categories.map((cat, i) => ({
                            label: cat,
                            data: data.values[i].map((val, colIdx) => (val / totals[colIdx]) * 100),
                            backgroundColor: data.colors[i]
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: { padding: { top: 25 } },
                        plugins: {
                            legend: { display: false },
                            circleTop: { enabled: true },
                            tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${ctx.raw.toFixed(1)}%` } }
                        },
                        scales: {
                            x: { stacked: true, grid: { display: false }, ticks: { font: { size: 10 } } },
                            y: { stacked: true, max: 100, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { callback: v => v + '%' } }
                        }
                    }
                });
            } else if (type === 'grouped') {
                participantsCharts.householdPosition = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: data.categories.map((cat, i) => ({
                            label: cat,
                            data: data.values[i],
                            backgroundColor: data.colors[i]
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: { padding: { top: 25 } },
                        plugins: { legend: { display: false }, circleTop: { enabled: true } },
                        scales: {
                            x: { grid: { display: false }, ticks: { font: { size: 10 } } },
                            y: { grid: { color: 'rgba(0,0,0,0.05)' } }
                        }
                    }
                });
            } else if (type === 'matrix') {
                // Matrix Heatmap - categories as rows, circles as columns
                const maxVal = Math.max(...data.values.flat());
                const container = ctx.parentElement;
                ctx.style.display = 'none';

                const existingMatrix = container.querySelector('.matrix-heatmap');
                if (existingMatrix) existingMatrix.remove();

                const matrix = document.createElement('div');
                matrix.className = 'matrix-heatmap';
                matrix.style.cssText = 'display: grid; grid-template-columns: 110px repeat(' + data.labels.length + ', 1fr); gap: 2px; height: 100%; font-size: 9px;';

                // Header row (circles)
                matrix.innerHTML = '<div></div>' + data.labels.map(l => `<div style="text-align: center; font-weight: 600; padding: 4px; overflow: hidden; text-overflow: ellipsis;">${l}</div>`).join('');

                // Data rows (categories)
                data.categories.forEach((cat, rowIdx) => {
                    matrix.innerHTML += `<div style="display: flex; align-items: center; font-weight: 600; font-size: 8px;">${cat}</div>`;
                    data.values[rowIdx].forEach(val => {
                        const intensity = Math.pow(val / maxVal, 0.5);
                        // Orange/amber gradient for household positions
                        const r = Math.round(255 - (intensity * 6));
                        const g = Math.round(230 - (intensity * 115));
                        const b = Math.round(200 - (intensity * 178));
                        matrix.innerHTML += `<div style="background: rgb(${r},${g},${b}); display: flex; align-items: center; justify-content: center; font-weight: 500; color: ${intensity > 0.5 ? '#fff' : '#333'};" title="${val.toLocaleString()}">${val >= 1000 ? (val/1000).toFixed(1) + 'k' : val}</div>`;
                    });
                });

                container.appendChild(matrix);
                participantsCharts.householdPosition = { destroy: () => { matrix.remove(); ctx.style.display = 'block'; } };
            }
        }

        // Circle Configuration - Toggle Groups
        function toggleConfigGroup(group) {
            const content = document.getElementById('config-group-' + group);
            const chevron = document.querySelector('.config-chevron-' + group);

            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                chevron.style.transform = 'rotate(0deg)';
            } else {
                content.classList.add('hidden');
                chevron.style.transform = 'rotate(-90deg)';
            }
        }

        // Multiselect Dropdown Functions
        function toggleMultiselect(btn) {
            const multiselect = btn.closest('.multiselect');
            const wasOpen = multiselect.classList.contains('open');

            // Close all other multiselects
            document.querySelectorAll('.multiselect.open').forEach(ms => {
                ms.classList.remove('open');
            });

            // Toggle this one
            if (!wasOpen) {
                multiselect.classList.add('open');
            }
        }

        // Close multiselect when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.multiselect')) {
                document.querySelectorAll('.multiselect.open').forEach(ms => {
                    ms.classList.remove('open');
                });
            }
        });

        // Handle checkbox changes in multiselects
        document.querySelectorAll('.multiselect-option').forEach(option => {
            option.addEventListener('click', function(e) {
                if (e.target.tagName !== 'INPUT') {
                    const checkbox = this.querySelector('input[type="checkbox"]');
                    checkbox.checked = !checkbox.checked;
                }

                const multiselect = this.closest('.multiselect');
                updateMultiselectLabel(multiselect);
                updateSelectAllState(multiselect);
                this.classList.toggle('selected', this.querySelector('input').checked);
            });
        });

        // Handle Select All checkbox
        document.querySelectorAll('.multiselect-select-all').forEach(selectAll => {
            selectAll.addEventListener('click', function(e) {
                if (e.target.tagName !== 'INPUT') {
                    const checkbox = this.querySelector('input[type="checkbox"]');
                    checkbox.checked = !checkbox.checked;
                }

                const multiselect = this.closest('.multiselect');
                const isChecked = this.querySelector('input').checked;

                // Toggle all option checkboxes
                multiselect.querySelectorAll('.multiselect-option input[type="checkbox"]').forEach(cb => {
                    cb.checked = isChecked;
                    cb.closest('.multiselect-option').classList.toggle('selected', isChecked);
                });

                updateMultiselectLabel(multiselect);
            });
        });

        function updateSelectAllState(multiselect) {
            const options = multiselect.querySelectorAll('.multiselect-option input[type="checkbox"]');
            const checkedOptions = multiselect.querySelectorAll('.multiselect-option input[type="checkbox"]:checked');
            const selectAllCheckbox = multiselect.querySelector('.multiselect-select-all input[type="checkbox"]');

            // If nothing is selected, auto-select all
            if (checkedOptions.length === 0) {
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = true;
                }
                options.forEach(cb => {
                    cb.checked = true;
                    cb.closest('.multiselect-option').classList.add('selected');
                });
                updateMultiselectLabel(multiselect);
            } else if (selectAllCheckbox) {
                selectAllCheckbox.checked = options.length === checkedOptions.length;
            }
        }

        function updateMultiselectLabel(multiselect) {
            const filterType = multiselect.dataset.filter;
            const optionCheckboxes = multiselect.querySelectorAll('.multiselect-option input[type="checkbox"]');
            const checkedOptionCheckboxes = multiselect.querySelectorAll('.multiselect-option input[type="checkbox"]:checked');
            const labelEl = multiselect.querySelector('.multiselect-label');

            const defaultLabels = {
                'campus': 'All Campuses',
                'participant-type': 'All Types',
                'engagement': 'All Engagement',
                'household-position': 'All Positions',
                'marital-status': 'All Statuses',
                'gender': 'All Genders'
            };

            // If none selected OR all selected, show "All X"
            if (checkedOptionCheckboxes.length === 0 || checkedOptionCheckboxes.length === optionCheckboxes.length) {
                labelEl.innerHTML = defaultLabels[filterType] || 'All';
            } else if (checkedOptionCheckboxes.length === 1) {
                const selectedLabel = checkedOptionCheckboxes[0].closest('.multiselect-option').querySelector('label').textContent;
                labelEl.innerHTML = selectedLabel;
            } else {
                const singularLabels = {
                    'campus': 'Campuses',
                    'participant-type': 'Types',
                    'engagement': 'Levels',
                    'household-position': 'Positions',
                    'marital-status': 'Statuses',
                    'gender': 'Genders'
                };
                labelEl.innerHTML = `<span class="multiselect-badge">${checkedOptionCheckboxes.length}</span> ${singularLabels[filterType] || 'Selected'}`;
            }
        }

        function resetAllFilters() {
            document.querySelectorAll('.multiselect').forEach(multiselect => {
                // Select all checkboxes (default state)
                multiselect.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = true;
                });
                multiselect.querySelectorAll('.multiselect-option').forEach(opt => {
                    opt.classList.add('selected');
                });
                updateMultiselectLabel(multiselect);
            });
        }
    </script>
</body>
</html>
